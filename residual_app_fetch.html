<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Residual App — By Ricardo</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0e1a">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #0a0e1a;
    --bg-gradient: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 100%);
    --card: rgba(255, 255, 255, 0.03);
    --card-hover: rgba(255, 255, 255, 0.07);
    --text: #e6ebff;
    --muted: #8b92b0;
    --border: rgba(255, 255, 255, 0.08);
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --accent-glow: rgba(59, 130, 246, 0.3);
    --chip: #1e293b;
    --chip-text: #cbd5e1;
    --danger: #ef4444;
    --success: #10b981;
    --radius: 16px;
    --shadow: 0 20px 50px rgba(0,0,0,0.4);
    --glow: 0 0 20px var(--accent-glow);
    --badge: #1e293b;
    --badge-border: #334155;
  }
  [data-theme="light"]{
    --bg: #f8fafc;
    --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    --card: #ffffff;
    --card-hover: #f8fafc;
    --text: #0f172a;
    --muted: #64748b;
    --border: #e2e8f0;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --accent-glow: rgba(59, 130, 246, 0.15);
    --chip: #f1f5f9;
    --chip-text: #475569;
    --shadow: 0 20px 50px rgba(15,23,42,0.08);
    --glow: 0 0 30px rgba(59, 130, 246, 0.1);
    --badge: #f1f5f9;
    --badge-border: #cbd5e1;
  }

  *{ box-sizing: border-box; margin: 0; padding: 0; }
  html, body{
    background: var(--bg); background-image: var(--bg-gradient); background-attachment: fixed;
    color: var(--text); font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 16px; line-height: 1.6; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    min-height: 100%;
  }
  .wrap{ max-width: 1200px; margin: 0 auto; padding: 20px 16px 80px; } /* extra bottom padding helps mobile scrolling */
  body::before{ content:''; position:fixed; top:0; left:0; right:0; height:400px;
    background: radial-gradient(circle at 50% 0%, var(--accent-glow), transparent 60%); opacity:.35; pointer-events:none; z-index:0; }

  .top{
    position: sticky; top: 0; z-index: 40; backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
    background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 12px 14px; margin-bottom: 16px; box-shadow: var(--shadow);
  }
  .brand{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .leftRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .pill{
    display:inline-flex; align-items:center; gap:10px; background:linear-gradient(135deg,var(--accent),var(--accent-hover));
    color:#fff; padding:8px 12px; border-radius:999px; font-weight:800; font-size:.9rem; letter-spacing:.3px;
    box-shadow:0 4px 20px var(--accent-glow); white-space:nowrap;
  }
  .theme, .btn{
    border:1px solid var(--border); background:var(--card); color:var(--text);
    padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; transition:.2s; white-space:nowrap;
  }
  .theme:hover, .btn:hover{ background:var(--card-hover); border-color:var(--accent); transform:translateY(-1px); box-shadow:0 4px 16px var(--accent-glow); }

  .select{ min-width: 170px; }

  .card{
    background:var(--card); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
    border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px;
  }
  .controls{ position: sticky; top: 60px; z-index: 20; }
  /* MOBILE: disable sticky to avoid trapping the Summary */
  @media (max-width: 900px){
    .controls{ position: static; }
  }

  .grid{ display:grid; gap: 14px; }
  .g4{ grid-template-columns: repeat(4, minmax(0,1fr)); }
  .g3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
  .g2{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  @media (max-width: 900px){ .g4,.g3,.g2{ grid-template-columns: 1fr; } }

  label{ font-size:.8rem; color:var(--muted); display:block; margin:0 0 6px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; }
  select, input[type="number"], input[type="text"]{
    width:100%; appearance:none; -webkit-appearance:none; background:var(--bg); color:var(--text);
    border:1px solid var(--border); border-radius:12px; padding:9px 12px; font-size:.95rem; transition:.2s;
  }
  select:focus, input:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); background:var(--card); }
  select:hover, input:hover{ border-color:var(--accent); }
  select{ cursor:pointer; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:right 10px center; padding-right:34px; }

  .muted{ color:var(--muted); }
  .hint{ font-size:.8rem; color:var(--muted); margin-top:6px; font-weight:500; }

  .searchWrap{ max-width:240px; min-width:200px; }
  .rowline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .result{ display:flex; align-items:baseline; gap:16px; margin:18px 0 14px; flex-wrap:wrap; padding:16px;
    background:linear-gradient(135deg, var(--accent-glow), transparent); border-radius:12px; border:1px solid var(--border); }
  .result .big{ font-size:2.3rem; font-weight:900; letter-spacing:.4px; background:linear-gradient(135deg,var(--accent),var(--accent-hover)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
  .result .small{ font-size:1rem; font-weight:600; }

  .tableWrap{ margin-top: 10px; overflow-x:auto; -webkit-overflow-scrolling:touch; border:1px solid var(--border); border-radius:12px; background:var(--bg); }
  table{ min-width:720px; width:100%; border-collapse:separate; border-spacing:0; }
  th, td{ padding:12px 14px; border-bottom:1px solid var(--border); text-align:left; white-space:nowrap; transition:.2s; }
  thead th{ font-size:.78rem; color:var(--muted); font-weight:800; position:sticky; top:0; background:var(--card);
    backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); z-index:1; text-transform:uppercase; letter-spacing:.5px; }
  tbody tr:hover{ background: var(--card-hover); }
  td.ok{ color:var(--success); font-weight:800; font-variant-numeric:tabular-nums; }
  td.err{ color:var(--danger); opacity:.55; }
  td:first-child, th:first-child{ position:sticky; left:0; background:var(--card); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); z-index:2; font-weight:800; }

  .summary{ margin-top: 16px; padding: 18px; border:1px solid var(--border); border-radius: var(--radius); background: var(--card);
    scroll-margin-top: 80px; } /* when jumping to summary, avoid hiding under sticky top */
  .sum-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-top:12px; }
  @media (max-width: 700px){ .sum-grid{ grid-template-columns:1fr; } }
  .srow{ display:flex; gap:12px; align-items:center; justify-content:space-between; background:var(--badge); border:1px solid var(--badge-border); border-radius:12px; padding:10px 12px; }
  .slabel{ font-weight:700; color:var(--muted); font-size:.9rem; }
  .sval{ font-variant-numeric:tabular-nums; font-weight:800; font-size:1rem; }
  .badges{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
  .badge{ background:linear-gradient(135deg,var(--badge),var(--badge-border)); border:1px solid var(--badge-border); padding:6px 10px; border-radius:999px; font-size:.82rem; font-weight:800; }

  .footer{ margin:24px 0 12px; }
  .foot-card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; }
  .foot-title{ font-weight:900; letter-spacing:.3px; margin-bottom:6px; font-size:1.05rem; }
  .foot-text{ color:var(--muted); font-size:.92rem; }

  @media print{
    body{ background:#fff; }
    .top, .controls, .tableWrap, #leaseCard, .footer, #validatorCard { display:none !important; }
    .summary{ border:0; box-shadow:none; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="leftRow">
          <div class="pill">Residual App — By Ricardo</div>
          <select id="programSel" class="select">
            <option value="__current__">Program: Current (from ?data or default)</option>
            <option value="porsche_residuals_all.json">Program: PB 25-10R (Default)</option>
            <option value="porsche_residuals_25-09R.json">Program: PB 25-09R (Oct)</option>
          </select>
        </div>
        <div class="leftRow">
          <button id="jumpSummaryBtn" class="btn" type="button" title="Scroll to Summary">Summary</button>
          <button id="validateBtn" class="btn" type="button" title="Validate loaded JSON">Validate JSON</button>
          <button id="exportCsvBtn" class="btn" type="button" title="Export table as CSV">Export</button>
          <button id="printBtn" class="btn" type="button" title="Print summary">Print</button>
          <button id="themeBtn" class="theme" type="button">Dark Mode</button>
        </div>
      </div>
    </div>

    <div class="card controls" id="controls">
      <div class="grid g4">
        <div>
          <label>Model Family</label>
          <select id="familySel"></select>
        </div>
        <div>
          <label>Model Year</label>
          <select id="yearSel"></select>
        </div>
        <div>
          <label>Trim</label>
          <select id="trimSel"></select>
          <div class="hint" id="trimCount"></div>
          <div class="hint" id="trimWarn" style="display:none;">No trims found for this family/year. Check JSON spelling/case.</div>
        </div>
        <div class="searchWrap">
          <label>Search Trim</label>
          <input id="trimSearch" type="text" placeholder="Type to filter by name or code" />
        </div>
      </div>

      <div class="grid g3" style="margin-top: 10px">
        <div>
          <label>Term (months)</label>
          <select id="termSel"></select>
        </div>
        <div>
          <label>Miles per Year</label>
          <select id="annualMilesSel"></select>
        </div>
        <div class="rowline" style="margin-top: 26px">
          <label class="rowline" style="gap: 8px;">
            <input id="pacpoToggle" type="checkbox" />
            <span>+2% PACPO</span>
          </label>
          <label class="rowline" style="gap: 8px;">
            <input id="hideNA" type="checkbox" />
            <span>Hide N/A</span>
          </label>
          <div class="pill" id="codeBadge" style="font-size:.82rem;padding:6px 10px;">MY Code: -</div>
        </div>
      </div>

      <div class="grid g3" style="margin-top: 10px">
        <div>
          <label>Miles at Inception</label>
          <input id="odoInput" type="number" min="0" step="1" placeholder="e.g., 3,450" />
          <div class="hint">Adjustment shows even when it is +0%.</div>
        </div>
        <div>
          <label>MSRP ($)</label>
          <input id="msrpInput" type="number" min="0" step="100" placeholder="e.g., 142,000" />
        </div>
        <div>
          <label>Shareable Link</label>
          <input id="shareLink" type="text" readonly />
          <div class="hint">URL auto-updates — copy to share this exact calc.</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 16px">
      <div class="result">
        <div class="big" id="finalOut">-</div>
        <div class="small muted" id="detailOut">Select a term to calculate</div>
        <div class="small" id="trueOut" style="font-weight:800;"></div>
        <div class="small muted" id="lviBadge" style="font-weight:700;"></div>
      </div>

      <div class="tableWrap">
        <table id="residualTable">
          <thead><tr id="theadRow"></tr></thead>
          <tbody><tr id="tvalRow"></tr></tbody>
        </table>
      </div>

      <div class="summary" id="summaryBox">
        <div class="rowline" style="justify-content:space-between;">
          <strong style="font-size:1.05rem">Summary</strong>
          <button id="copyBtn" class="theme btn" type="button">Copy</button>
        </div>

        <div class="srow" style="margin-top:12px; border:2px solid var(--accent); box-shadow: var(--glow);">
          <span class="slabel" style="color:var(--accent);">Final Residual</span>
          <span class="sval" id="sumFinal" style="font-size:1.2rem;color:var(--accent);">-</span>
        </div>

        <!-- Clean 2-column pairs -->
        <div class="sum-grid">
          <!-- Program (hidden but kept for copy/export) -->
          <div class="srow" style="display:none;">
            <span class="slabel">Program</span><span class="sval" id="sumProgram">-</span>
          </div>

          <!-- Pair 1 -->
          <div class="srow"><span class="slabel">Model Year</span><span class="sval" id="sumYear">-</span></div>
          <div class="srow"><span class="slabel">Family</span><span class="sval" id="sumFamily">-</span></div>

          <!-- Pair 2 -->
          <div class="srow"><span class="slabel">Trim</span><span class="sval" id="sumTrim">-</span></div>
          <div class="srow"><span class="slabel">Term</span><span class="sval" id="sumTerm">-</span></div>

          <!-- Pair 3 -->
          <div class="srow"><span class="slabel">Miles/Year</span><span class="sval" id="sumMilesYear">-</span></div>
          <div class="srow"><span class="slabel">Odometer</span><span class="sval" id="sumOdo">-</span></div>

          <!-- MSRP (hidden but kept for copy/export) -->
          <div class="srow" style="display:none;">
            <span class="slabel">MSRP</span><span class="sval" id="sumMsrp">-</span>
          </div>

          <!-- Always shown -->
          <div class="srow"><span class="slabel">MSRP × RV%</span><span class="sval" id="sumTrue">-</span></div>
          <div class="srow">
            <span class="slabel">Lease Value Index</span>
            <span class="sval" id="sumLvi" title="*The Higher the Lease Value Index the better">-</span>
          </div>
        </div>
        <div class="hint" id="lviHelp">*The Higher the Lease Value Index the better</div>

        <div class="badges" id="badgeRow" aria-label="Adjustments"></div>
      </div>
    </div>

    <!-- Lease Estimator (Quick) -->
    <div class="card" id="leaseCard" style="margin-top: 16px;">
      <div class="rowline" style="justify-content:space-between; margin-bottom:8px;">
        <strong>Lease Estimator (Quick)</strong>
        <span class="muted" style="font-size:.9rem">Manual MF/Tax/Cap — uses current RV% & term</span>
      </div>

      <div class="grid g3">
        <div>
          <label>Cap Cost ($)</label>
          <input id="leaseCapCost" type="number" min="0" step="100" placeholder="e.g., 165000" />
          <div class="hint">Selling price before down payment</div>
        </div>
        <div>
          <label>Money Factor</label>
          <input id="leaseMF" type="number" min="0" step="0.00001" placeholder="e.g., 0.00210" />
          <div class="hint">Enter as decimal (0.00210 ≈ 5.04% APR)</div>
          <div class="hint" id="mfAprHint"></div>
        </div>
        <div>
          <label>Tax Rate (%)</label>
          <input id="leaseTax" type="number" min="0" step="0.01" placeholder="e.g., 9.375" />
        </div>
      </div>

      <div class="grid g3" style="margin-top:10px">
        <div>
          <label>Cap Reduction ($)</label>
          <input id="leaseCapReduction" type="number" min="0" step="100" placeholder="0" />
          <div class="hint">Cash down applied to reduce cap (optional)</div>
        </div>
        <div>
          <label>Rolled-In Fees ($)</label>
          <input id="leaseFees" type="number" min="0" step="25" placeholder="0" />
          <div class="hint">Acq/Doc/etc. added to cap (optional)</div>
        </div>
        <div>
          <label>Term (mo)</label>
          <input id="leaseTerm" type="number" min="12" step="1" placeholder="auto" />
          <div class="hint">Auto-fills from selected term; you can override</div>
        </div>
      </div>

      <div class="grid g3" style="margin-top:12px">
        <div class="srow"><span class="slabel">Residual %</span><span class="sval" id="leaseRvPct">-</span></div>
        <div class="srow"><span class="slabel">Residual $</span><span class="sval" id="leaseRvAmt">-</span></div>
        <div class="srow"><span class="slabel">Adj Cap Cost</span><span class="sval" id="leaseAdjCap">-</span></div>
      </div>

      <div class="grid g2" style="margin-top:12px">
        <div class="srow"><span class="slabel">Monthly (Pre-Tax)</span><span class="sval" id="leasePreTax">-</span></div>
        <div class="srow"><span class="slabel">Monthly (With Tax)</span><span class="sval" id="leaseWithTax">-</span></div>
      </div>
    </div>

    <!-- Validator Panel -->
    <div class="card" id="validatorCard" style="margin-top:12px; display:none;">
      <div class="rowline" style="justify-content:space-between; margin-bottom:8px;">
        <strong>JSON Validator</strong>
        <button id="closeValBtn" class="btn" type="button">Close</button>
      </div>
      <div id="validatorOutput" class="muted" style="font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.9rem;"></div>
    </div>

    <div class="footer">
      <div class="foot-card">
        <div class="foot-title">Made by Ricardo</div>
        <div class="foot-text">
          © Ricardo. This internal tool is confidential and intended for authorized use only.
          Do not share, copy, or redistribute without written permission.
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // Simple PWA bits (optional, safe if it fails)
  (function generateIconsAndManifest(){
    try{
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 512;
      const ctx = canvas.getContext('2d');
      const grad = ctx.createLinearGradient(0,0,512,512);
      grad.addColorStop(0,'#0a0e1a'); grad.addColorStop(1,'#1a1f35');
      ctx.fillStyle = grad; ctx.fillRect(0,0,512,512);
      ctx.fillStyle = '#3b82f6';
      ctx.beginPath(); ctx.arc(256, 220, 120, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#0a0e1a';
      ctx.font = 'bold 180px Inter, Arial, sans-serif';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText('R', 256, 230);

      canvas.toBlob(function(blob){
        if(!blob) return;
        const iconURL = URL.createObjectURL(blob);
        const linkApple = document.createElement('link'); linkApple.rel = 'apple-touch-icon'; linkApple.href = iconURL;
        document.head.appendChild(linkApple);

        const manifest = {
          name: "Residual App — By Ricardo",
          short_name: "Residual",
          start_url: ".",
          display: "standalone",
          background_color: "#0a0e1a",
          theme_color: "#0a0e1a",
          icons: [{ src: iconURL, sizes: "512x512", type: "image/png", purpose: "any maskable" }]
        };
        const blobMan = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
        const manURL = URL.createObjectURL(blobMan);
        const linkMan = document.createElement('link'); linkMan.rel = 'manifest'; linkMan.href = manURL;
        document.head.appendChild(linkMan);
      }, 'image/png');
    }catch(e){ /* ignore */ }
  })();

  // Theme
  var themeBtn = document.getElementById('themeBtn');
  var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
  themeBtn.textContent = prefersDark ? 'Light Mode' : 'Dark Mode';
  themeBtn.addEventListener('click', function(){
    var cur = document.documentElement.getAttribute('data-theme');
    var next = cur === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    themeBtn.textContent = next === 'light' ? 'Dark Mode' : 'Light Mode';
  });

  // DOM refs
  var programSel = document.getElementById('programSel');
  var validateBtn = document.getElementById('validateBtn');
  var exportCsvBtn = document.getElementById('exportCsvBtn');
  var printBtn = document.getElementById('printBtn');
  var jumpSummaryBtn = document.getElementById('jumpSummaryBtn');

  var familySel = document.getElementById('familySel');
  var yearSel = document.getElementById('yearSel');
  var trimSel = document.getElementById('trimSel');
  var trimSearch = document.getElementById('trimSearch');
  var trimCount = document.getElementById('trimCount');
  var trimWarn = document.getElementById('trimWarn');
  var termSel = document.getElementById('termSel');
  var pacpoToggle = document.getElementById('pacpoToggle');
  var hideNA = document.getElementById('hideNA');
  var codeBadge = document.getElementById('codeBadge');
  var finalOut = document.getElementById('finalOut');
  var detailOut = document.getElementById('detailOut');
  var trueOut = document.getElementById('trueOut');
  var theadRow = document.getElementById('theadRow');
  var tvalRow = document.getElementById('tvalRow');
  var annualMilesSel = document.getElementById('annualMilesSel');
  var odoInput = document.getElementById('odoInput');
  var msrpInput = document.getElementById('msrpInput');
  var shareLink = document.getElementById('shareLink');

  var sumProgram = document.getElementById('sumProgram');
  var sumYear = document.getElementById('sumYear');
  var sumFamily = document.getElementById('sumFamily');
  var sumTrim = document.getElementById('sumTrim');
  var sumTerm = document.getElementById('sumTerm');
  var sumMilesYear = document.getElementById('sumMilesYear');
  var sumOdo = document.getElementById('sumOdo');
  var sumMsrp = document.getElementById('sumMsrp');
  var sumTrue = document.getElementById('sumTrue');
  var sumFinal = document.getElementById('sumFinal');
  var badgeRow = document.getElementById('badgeRow');
  var copyBtn = document.getElementById('copyBtn');

  var leaseCapCost = document.getElementById('leaseCapCost');
  var leaseMF = document.getElementById('leaseMF');
  var leaseTax = document.getElementById('leaseTax');
  var leaseCapReduction = document.getElementById('leaseCapReduction');
  var leaseFees = document.getElementById('leaseFees');
  var leaseTerm = document.getElementById('leaseTerm');
  var leaseRvPct = document.getElementById('leaseRvPct');
  var leaseRvAmt = document.getElementById('leaseRvAmt');
  var leaseAdjCap = document.getElementById('leaseAdjCap');
  var leasePreTax = document.getElementById('leasePreTax');
  var leaseWithTax = document.getElementById('leaseWithTax');
  var mfAprHint = document.getElementById('mfAprHint');

  var lviBadge = document.getElementById('lviBadge');
  var sumLvi = document.getElementById('sumLvi');

  var validatorCard = document.getElementById('validatorCard');
  var closeValBtn = document.getElementById('closeValBtn');
  var validatorOutput = document.getElementById('validatorOutput');

  var data, MONTHS = [], PACPO = 2;
  var fullTrimList = [];
  var currentProgramLabel = 'Current';

  function readParams(){
    var p = new URLSearchParams(location.search);
    return {
      program: p.get('data') || null, family: p.get('family') || null, year: p.get('year') || null,
      trim: p.get('trim') || null, term: p.get('term') || null, miles: p.get('miles') || null,
      odo: p.get('odo') || null, pacpo: p.get('pacpo') || null, hidena: p.get('hidena') || null,
      msrp: p.get('msrp') || null
    };
  }
  function updateShareURL(){
    var p = new URLSearchParams();
    var program = (programSel.value === '__current__') ? (initialProgram || 'porsche_residuals_all.json') : programSel.value;
    p.set('data', program);
    if(familySel.value) p.set('family', familySel.value);
    if(yearSel.value) p.set('year', yearSel.value);
    if(trimSel.value) p.set('trim', trimSel.value);
    if(termSel.value) p.set('term', termSel.value);
    if(annualMilesSel.value) p.set('miles', annualMilesSel.value);
    if(odoInput.value) p.set('odo', odoInput.value);
    if(pacpoToggle.checked) p.set('pacpo', '1');
    if(hideNA.checked) p.set('hidena', '1');
    if(msrpInput.value) p.set('msrp', msrpInput.value);
    var url = location.pathname + '?' + p.toString();
    shareLink.value = location.origin + url;
    history.replaceState(null, '', url);
  }

  var initialProgram = (function(){
    var params = new URLSearchParams(location.search);
    return params.get('data') || 'porsche_residuals_all.json';
  })();

  function loadProgram(file, label){
    var cacheBuster = 't=' + Date.now();
    currentProgramLabel = label || (file === '__current__' ? 'Current' : file);
    var target = (file === '__current__') ? initialProgram : file;
    return fetch(target + '?' + cacheBuster, {cache:'no-store'})
      .then(function(res){
        if(!res.ok) throw new Error('HTTP ' + res.status + ' loading ' + target);
        return res.json();
      })
      .then(function(j){
        data = j; window.__data = data;
        MONTHS = data.months || ["12","18","24","27","30","36","39","42","48","51","60"];
        PACPO = data.pacpo_bonus_percent || 2;
        sumProgram.textContent = label || target;
        initSelectors();
        restoreFromParams();
        compute();
        updateShareURL();
      });
  }

  function normalizeYearKey(k){
    var s = String(k).trim();
    var mPlain = s.match(/^(20\d{2})$/); if (mPlain) return { display: 'MY' + mPlain[1].slice(-2), key: k };
    var mMY = s.toUpperCase().replace(/\s+/g,'').match(/^MY(\d{2})$/); if (mMY) return { display: 'MY' + mMY[1], key: k };
    return { display: s, key: k };
  }
  function getCaseInsensitive(obj, name){
    if(!obj || typeof obj !== "object") return undefined;
    var target = String(name).replace(/\s+/g,'').toLowerCase();
    var keys = Object.keys(obj);
    for(var i=0;i<keys.length;i++){ if(keys[i].replace(/\s+/g,'').toLowerCase() === target) return obj[keys[i]]; }
    return undefined;
  }
  function getVirtualFamilies(){
    var out = new Set();
    var models = data.models || {};
    Object.keys(models).forEach(function(f){
      if(f === '718'){
        var cay = getCaseInsensitive(models['718'],'Cayman');
        var box = getCaseInsensitive(models['718'],'Boxster');
        if (cay) out.add('718 Cayman'); if (box) out.add('718 Boxster');
      } else { out.add(f); }
    });
    if(models['Cayman']) out.add('718 Cayman');
    if(models['Boxster']) out.add('718 Boxster');
    var order = ['911','718 Cayman','718 Boxster','Taycan','Macan','Cayenne','Panamera'];
    return Array.from(out).sort(function(a,b){ return order.indexOf(a) - order.indexOf(b); });
  }
  function branchForFamily(famDisp){
    var models = data.models || {};
    if (famDisp === '718 Cayman'){
      return getCaseInsensitive(models['718']||{}, 'Cayman') || models['Cayman'] || {};
    }
    if (famDisp === '718 Boxster'){
      return getCaseInsensitive(models['718']||{}, 'Boxster') || models['Boxster'] || {};
    }
    return models[famDisp] || {};
  }
  function yearsForFamily(famDisp){
    var out = new Set(); var branch = branchForFamily(famDisp);
    Object.keys(branch).forEach(function(k){ out.add(normalizeYearKey(k).display); });
    return Array.from(out).sort(function(a,b){
      var ay = parseInt(a.replace(/\D/g,''),10), by = parseInt(b.replace(/\D/g,''),10);
      if (isNaN(ay) || isNaN(by)) return b.localeCompare(a);
      return by - ay;
    });
  }

  function populate(select, arr){
    select.innerHTML = '';
    arr.forEach(function(v){ var opt = document.createElement('option'); opt.value = v; opt.textContent = v; select.appendChild(opt); });
  }
  function initSelectors(){
    populate(familySel, getVirtualFamilies());
    populate(yearSel, yearsForFamily(familySel.value));
    termSel.innerHTML = '';
    MONTHS.forEach(function(m){ var opt = document.createElement('option'); opt.value = m; opt.textContent = m + ' months'; termSel.appendChild(opt); });
    populateAnnualMiles();
    collectTrimsForYear();
    populateTrims('');
  }
  function populateAnnualMiles(){
    annualMilesSel.innerHTML = '';
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {
      "2500":6,"5000":5,"7500":4,"10000":3,"12000":2,"15000":0
    };
    Object.keys(milesMap).map(function(k){ return parseInt(k,10); }).sort(function(a,b){ return a-b; })
      .forEach(function(n){ var opt = document.createElement('option'); opt.value = String(n); opt.textContent = n.toLocaleString() + ' mi/yr'; annualMilesSel.appendChild(opt); });
    annualMilesSel.value = "15000";
  }
  function collectTrimsForYear(){
    fullTrimList = [];
    var branch = branchForFamily(familySel.value);
    var dispYear = yearSel.value;
    var yearKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    var rows = (yearKey && branch[yearKey]) || {};
    Object.entries(rows).forEach(function([code,row]){ fullTrimList.push({code: code, model: row.model || code}); });
  }
  function populateTrims(filterTerm){
    trimSel.innerHTML = '';
    var term = (filterTerm||'').trim().toLowerCase();
    var filtered = fullTrimList.filter(function(t){ return (t.model + " " + t.code).toLowerCase().indexOf(term) !== -1; });
    filtered.forEach(function(item){ var opt = document.createElement('option'); opt.value = item.code; opt.textContent = item.model; opt.dataset.code = item.code; trimSel.appendChild(opt); });
    trimCount.textContent = filtered.length ? (filtered.length + ' trim(s) available') : 'No trims match filter';
    trimWarn.style.display = filtered.length ? 'none' : 'block';
  }

  function parseRange(str){
    if(!str) return null;
    var s = str.replace(/,/g,'').replace(/\s/g,'');
    var parts = s.split(/–|-/); if(parts.length !== 2) return null;
    var a = parseInt(parts[0],10), b = parseInt(parts[1],10);
    if(isNaN(a) || isNaN(b)) return null;
    return [a,b];
  }
  function findInceptionAdj(myKey, odo){
    var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[myKey]) || null;
    if(!bands || odo == null) return 0;
    for(var i=0;i<bands.length;i++){
      var rng = parseRange(bands[i].miles_range); if(!rng) continue;
      if(odo >= rng[0] && odo <= rng[1]) return bands[i].adj || 0;
    }
    return 0;
  }
  function visibleMonthsFor(entry){
    if(!hideNA.checked) return MONTHS.slice();
    var result = [];
    for(var i=0;i<MONTHS.length;i++){ if(entry && entry.residuals && entry.residuals[MONTHS[i]] != null) result.push(MONTHS[i]); }
    return result;
  }
  function buildHeader(visibleMonths){
    theadRow.innerHTML = '';
    var th1 = document.createElement('th'); th1.textContent = 'Trim / Term'; theadRow.appendChild(th1);
    visibleMonths.forEach(function(m){ var th = document.createElement('th'); th.textContent = m + ' mo'; theadRow.appendChild(th); });
  }

  function computeLVI(rvPercent, mf){ if(!isFinite(rvPercent) || !isFinite(mf) || mf <= 0) return null; return rvPercent / mf; }

  function compute(){
    var fam = familySel.value;
    var branch = branchForFamily(fam);
    var dispYear = yearSel.value;
    var yrKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    var code = trimSel.value;
    var term = termSel.value;
    var milesPerYear = parseInt(annualMilesSel.value, 10);
    var odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''), 10) : null;

    if(!yrKey || !code){
      finalOut.textContent = '-';
      detailOut.textContent = 'Select family/year/trim';
      trueOut.textContent = '';
      if(lviBadge) lviBadge.textContent = '';
      if(sumLvi) sumLvi.textContent = '-';
      updateShareURL();
      return;
    }

    var entry = branch[yrKey][code];
    var base = term ? ((entry && entry.residuals && entry.residuals[term]) || null) : null;

    var PACPO = data.pacpo_bonus_percent || 2;
    var pacpoAdj = pacpoToggle.checked ? PACPO : 0;

    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    var annualAdj = 0;
    if(base !== null && parseInt(term || "0", 10) >= 24){ annualAdj = milesMap[String(milesPerYear)] || 0; }

    var inceptionKeyCandidates = [yrKey, dispYear, dispYear.replace(/\s+/g,'')];
    var inceptionAdj = 0;
    for(var i=0;i<inceptionKeyCandidates.length;i++){
      var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[inceptionKeyCandidates[i]]) || null;
      if(bands){ inceptionAdj = findInceptionAdj(inceptionKeyCandidates[i], odo); break; }
    }

    var monthsShown = visibleMonthsFor(entry);
    buildHeader(monthsShown);

    var final = (base === null || term == null) ? null : (base + pacpoAdj + annualAdj + inceptionAdj);
    finalOut.textContent = final === null ? '-' : final + '%';
    detailOut.textContent = final === null ? 'Select a term to calculate' : 'Final residual with all adjustments applied';
    codeBadge.textContent = 'MY Code: ' + (code || '-');

    // table row
    tvalRow.innerHTML = '';
    var lead = document.createElement('td'); lead.textContent = (entry && entry.model) || '-'; tvalRow.appendChild(lead);
    monthsShown.forEach(function(m){
      var td = document.createElement('td');
      var v = entry && entry.residuals && entry.residuals[m];
      var shown = '-';
      if(v !== null && v !== undefined){
        var mN = parseInt(m, 10);
        var aAdj = (mN >= 24) ? (milesMap[String(milesPerYear)] || 0) : 0;
        var total = v + pacpoAdj + aAdj + inceptionAdj;
        shown = total + '%'; td.classList.add('ok');
      } else { td.classList.add('err'); }
      td.textContent = shown; tvalRow.appendChild(td);
    });

    // summary
    sumProgram.textContent = currentProgramLabel;
    sumYear.textContent = dispYear || '-';
    sumFamily.textContent = fam || '-';
    sumTrim.textContent = (entry && entry.model) || '-';
    sumTerm.textContent = term ? (term + ' mo') : '-';
    sumMilesYear.textContent = Number.isFinite(milesPerYear) ? milesPerYear.toLocaleString() + ' mi/yr' : '-';
    sumOdo.textContent = (odo != null && !isNaN(odo)) ? odo.toLocaleString() + ' mi' : '-';

    var msrp = msrpInput.value ? Number(msrpInput.value) : null;
    if (sumMsrp) sumMsrp.textContent = (msrp != null && !isNaN(msrp)) ? ('$' + msrp.toLocaleString()) : '-';
    var trueResidual = (final != null && msrp != null && !isNaN(msrp)) ? Math.round(msrp * (final/100)) : null;
    sumTrue.textContent = (trueResidual != null) ? ('$' + trueResidual.toLocaleString()) : '-';
    trueOut.textContent = (trueResidual != null) ? ('MSRP × RV% = $' + trueResidual.toLocaleString()) : '';

    // badges
    badgeRow.innerHTML = '';
    if(base !== null && term){ addBadge('Base ' + base + '%'); }
    if(pacpoToggle.checked){ addBadge('+' + PACPO + '% PACPO'); }
    if(term && parseInt(term, 10) >= 24){ addBadge(((annualAdj>=0?'+':'') + annualAdj + '%') + ' Annual Miles'); }
    if(odo != null && !isNaN(odo)){ addBadge(((inceptionAdj>=0?'+':'') + inceptionAdj + '%') + ' Inception'); }

    sumFinal.textContent = final === null ? '-' : final + '%';

    // LVI
    var mfVal = leaseMF && leaseMF.value ? Number(leaseMF.value) : NaN;
    var lviCurrent = computeLVI(final, mfVal);
    if(lviCurrent != null){
      var lviText = (lviCurrent/1000).toFixed(1) + ' k';
      if(lviBadge) lviBadge.textContent = 'Value Index: ' + lviText;
      if(sumLvi) sumLvi.textContent = lviText;
    } else {
      if(lviBadge) lviBadge.textContent = '';
      if(sumLvi) sumLvi.textContent = '-';
    }

    updateShareURL();

    if(leaseTerm && (!leaseTerm.value || leaseTerm.value === '')) {
      if(termSel && termSel.value) leaseTerm.value = termSel.value;
    }
    leaseCompute();
  }
  function addBadge(txt){
    var b = document.createElement('div'); b.className = 'badge'; b.textContent = txt; badgeRow.appendChild(b);
  }

  function exportVisibleCSV(){
    var fam = familySel.value;
    var branch = branchForFamily(fam);
    var dispYear = yearSel.value;
    var yrKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    if(!yrKey || !trimSel.value){ alert('Select family/year/trim first.'); return; }
    var entry = branch[yrKey][trimSel.value];
    var monthsShown = visibleMonthsFor(entry);

    var rows = [];
    rows.push(['Trim/Term'].concat(monthsShown.map(function(m){return m + ' mo';})));
    var line = [(entry && entry.model) || '-'];
    var milesPerYear = parseInt(annualMilesSel.value, 10);

    var pacpoAdj = pacpoToggle.checked ? (data.pacpo_bonus_percent || 2) : 0;
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    var inceptionKeyCandidates = [yrKey, dispYear, dispYear.replace(/\s+/g,'')];
    var inceptionAdj = 0;
    var odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''), 10) : null;
    for(var i=0;i<inceptionKeyCandidates.length;i++){
      var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[inceptionKeyCandidates[i]]) || null;
      if(bands){ inceptionAdj = findInceptionAdj(inceptionKeyCandidates[i], odo); break; }
    }

    monthsShown.forEach(function(m){
      var v = entry && entry.residuals && entry.residuals[m];
      if(v==null){ line.push(''); return; }
      var aAdj = (parseInt(m,10) >= 24) ? (milesMap[String(milesPerYear)] || 0) : 0;
      var total = v + pacpoAdj + aAdj + inceptionAdj;
      line.push(total + '%');
    });
    rows.push(line);

    rows.push([]);
    rows.push(['Program', currentProgramLabel]);
    rows.push(['Year', dispYear], ['Family', fam], ['Trim', (entry && entry.model)||'-'], ['Term', termSel.value ? termSel.value+' mo':'-']);
    rows.push(['Miles/Year', sumMilesYear.textContent], ['Odometer', sumOdo.textContent], ['Final Residual', sumFinal.textContent]);
    if(msrpInput.value){ rows.push(['MSRP', '$'+Number(msrpInput.value).toLocaleString()], ['MSRP × RV%', sumTrue.textContent]); }

    var csv = rows.map(function(r){
      return r.map(function(c){
        var s = (c==null ? '' : String(c));
        if(s.indexOf('"')!=-1 || s.indexOf(',')!=-1) s='"'+s.replace(/"/g,'""')+'"';
        return s;
      }).join(',');
    }).join('\r\n');

    var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    var safeTrim = ((entry && entry.model)||'trim').replace(/[^\w\-]+/g,'_');
    a.download = 'residual_' + safeTrim + '_' + (dispYear||'MY').replace(/\s+/g,'') + '.csv';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function printSummary(){ window.print(); }

  function validateJSON(){
    if(!data){ alert('Load a program first.'); return; }
    var issues = [];
    var models = data.models || {};
    var totalTrims = 0, missingCells = 0;

    function checkEntry(modelFamily, yearKey, code, entry){
      totalTrims++;
      var resids = entry.residuals || {};
      MONTHS.forEach(function(m){
        if(!(m in resids) || resids[m] == null){
          missingCells++;
          issues.push('Missing residual → ['+modelFamily+'] ['+yearKey+'] ['+(entry.model||code)+'] term '+m+' mo');
        }
      });
    }

    Object.keys(models).forEach(function(fam){
      var famBranch = models[fam];
      if(!famBranch || typeof famBranch!=='object') return;
      Object.keys(famBranch).forEach(function(yearKey){
        var group = famBranch[yearKey];
        if(!group || typeof group!=='object'){ issues.push('Bad year group at '+fam+' / '+yearKey); return; }
        Object.keys(group).forEach(function(code){
          var entry = group[code];
          if(!entry || typeof entry!=='object'){ issues.push('Bad trim entry at '+fam+' / '+yearKey+' / '+code); return; }
          if(!('model' in entry)) issues.push('No "model" field at '+fam+' / '+yearKey+' / '+code);
          if(!('residuals' in entry)) issues.push('No "residuals" map at '+fam+' / '+yearKey+' / '+code);
          else checkEntry(fam, yearKey, code, entry);
        });
      });
    });

    if(!data.annual_mileage_adjustments_percent || !data.annual_mileage_adjustments_percent.miles_per_year){
      issues.push('annual_mileage_adjustments_percent.miles_per_year is missing');
    }
    if(!data.mileage_at_inception_adjustments_percent){
      issues.push('mileage_at_inception_adjustments_percent is missing');
    }

    var out = [];
    out.push('Program: ' + (currentProgramLabel || 'Unknown'));
    out.push('MONTHS: ' + JSON.stringify(MONTHS));
    out.push('PACPO bonus: ' + (data.pacpo_bonus_percent || 2) + '%');
    out.push('Total trims scanned: ' + totalTrims);
    out.push('Missing cells: ' + missingCells);
    out.push('—');
    if(issues.length===0) out.push('✅ No issues found.');
    else out.push('⚠️ Issues ('+issues.length+'):');
    issues.forEach(function(line){ out.push(' - ' + line); });

    validatorOutput.textContent = out.join('\n');
    validatorCard.style.display = 'block';
  }

  function leaseCompute(){
    var rvPctText = sumFinal.textContent; // "58%" or "-"
    var rvPct = (rvPctText && rvPctText.endsWith('%')) ? parseFloat(rvPctText) : NaN;
    var msrp = msrpInput.value ? Number(msrpInput.value) : NaN;
    var term = leaseTerm.value ? parseInt(leaseTerm.value, 10)
                               : (termSel && termSel.value ? parseInt(termSel.value,10) : NaN);

    var cap = leaseCapCost.value ? Number(leaseCapCost.value) : NaN;
    var mf = leaseMF.value ? Number(leaseMF.value) : NaN;
    var tax = leaseTax.value ? Number(leaseTax.value)/100 : 0;
    var capRed = leaseCapReduction.value ? Number(leaseCapReduction.value) : 0;
    var fees = leaseFees.value ? Number(leaseFees.value) : 0;

    leaseRvPct.textContent = isFinite(rvPct) ? (rvPct.toFixed(2) + '%') : '-';

    if(!isFinite(msrp) || !isFinite(rvPct) || !isFinite(term) || term <= 0){
      leaseRvAmt.textContent = '-';
      leaseAdjCap.textContent = '-';
      leasePreTax.textContent = '-';
      leaseWithTax.textContent = '-';
      mfAprHint.textContent = isFinite(mf) ? ('≈ ' + (mf*2400).toFixed(2) + '% APR') : '';
      return;
    }

    var rvAmt = Math.round(msrp * (rvPct/100));
    leaseRvAmt.textContent = '$' + rvAmt.toLocaleString();

    var adjCap = (isFinite(cap) ? cap : 0) - (isFinite(capRed) ? capRed : 0) + (isFinite(fees) ? fees : 0);
    leaseAdjCap.textContent = isFinite(adjCap) ? ('$' + adjCap.toLocaleString()) : '-';

    if(!isFinite(adjCap) || adjCap <= 0 || !isFinite(mf) || mf <= 0){
      leasePreTax.textContent = '-';
      leaseWithTax.textContent = '-';
      mfAprHint.textContent = isFinite(mf) ? ('≈ ' + (mf*2400).toFixed(2) + '% APR') : '';
      return;
    }

    var dep = (adjCap - rvAmt) / term;
    var fin = (adjCap + rvAmt) * mf;
    var preTax = dep + fin;
    var withTax = preTax * (1 + (isFinite(tax) ? tax : 0));

    if(!isFinite(preTax) || preTax < 0){
      leasePreTax.textContent = '-';
      leaseWithTax.textContent = '-';
      mfAprHint.textContent = isFinite(mf) ? ('≈ ' + (mf*2400).toFixed(2) + '% APR') : '';
      return;
    }

    leasePreTax.textContent = '$' + Math.round(preTax).toLocaleString();
    leaseWithTax.textContent = '$' + Math.round(withTax).toLocaleString();
    mfAprHint.textContent = isFinite(mf) ? ('≈ ' + (mf*2400).toFixed(2) + '% APR') : '';
  }

  function restoreFromParams(){
    var p = readParams();
    if(p.family){ familySel.value = p.family; }
    populate(yearSel, yearsForFamily(familySel.value));
    if(p.year && Array.from(yearSel.options).some(o=>o.value===p.year)){ yearSel.value = p.year; }
    collectTrimsForYear(); populateTrims('');
    if(p.trim && Array.from(trimSel.options).some(o=>o.value===p.trim)){ trimSel.value = p.trim; }
    if(p.term && Array.from(termSel.options).some(o=>o.value===p.term)){ termSel.value = p.term; }
    if(p.miles){ annualMilesSel.value = p.miles; }
    if(p.odo){ odoInput.value = p.odo; }
    pacpoToggle.checked = (p.pacpo === '1');
    hideNA.checked = (p.hidena === '1');
    if(p.msrp){ msrpInput.value = p.msrp; }
  }

  // Events
  programSel.addEventListener('change', function(){
    var val = programSel.value;
    var label = programSel.options[programSel.selectedIndex].textContent.replace(/^Program:\s*/,'');
    loadProgram(val, label).catch(function(err){
      alert('Could not load program "'+val+'". Make sure the JSON exists in the same folder.\n\n' + err.message);
      programSel.value = '__current__';
    });
  });
  jumpSummaryBtn.addEventListener('click', function(){
    var el = document.getElementById('summaryBox');
    if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
  });

  familySel.addEventListener('change', function(){ populate(yearSel, yearsForFamily(familySel.value)); collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  yearSel.addEventListener('change', function(){ collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  trimSearch.addEventListener('input', function(){ populateTrims(trimSearch.value); compute(); });
  trimSel.addEventListener('change', compute);
  termSel.addEventListener('change', compute);
  pacpoToggle.addEventListener('change', compute);
  hideNA.addEventListener('change', compute);
  annualMilesSel.addEventListener('change', compute);
  odoInput.addEventListener('input', compute);
  msrpInput.addEventListener('input', compute);

  copyBtn.addEventListener('click', function(){
    var parts = [
      'Program: ' + (sumProgram ? sumProgram.textContent : '-'),
      'Year: ' + sumYear.textContent,
      'Family: ' + sumFamily.textContent,
      'Trim: ' + sumTrim.textContent,
      'Term: ' + sumTerm.textContent,
      'Miles/Year: ' + sumMilesYear.textContent,
      'Odometer: ' + sumOdo.textContent,
      (sumMsrp ? ('MSRP: ' + sumMsrp.textContent) : null),
      'Final Residual: ' + sumFinal.textContent,
      'MSRP × RV%: ' + sumTrue.textContent,
      'LVI: ' + (sumLvi ? sumLvi.textContent : '-')
    ].filter(Boolean);
    var text = parts.join(' | ');
    navigator.clipboard.writeText(text).then(function(){
      var old = copyBtn.textContent; copyBtn.textContent = 'Copied!'; setTimeout(function(){ copyBtn.textContent = old; }, 1200);
    });
  });

  exportCsvBtn.addEventListener('click', exportVisibleCSV);
  printBtn.addEventListener('click', printSummary);
  validateBtn.addEventListener('click', validateJSON);
  closeValBtn && closeValBtn.addEventListener('click', function(){ validatorCard.style.display='none'; });

  leaseCapCost.addEventListener('input', leaseCompute);
  leaseMF.addEventListener('input', leaseCompute);
  leaseTax.addEventListener('input', leaseCompute);
  leaseCapReduction.addEventListener('input', leaseCompute);
  leaseFees.addEventListener('input', leaseCompute);
  leaseTerm.addEventListener('input', leaseCompute);
  leaseMF.addEventListener('input', compute); // also update LVI live

  var initialParams = readParams();
  if(initialParams.program){
    var opt = Array.from(programSel.options).find(o=>o.value===initialParams.program);
    if(opt){ programSel.value = initialParams.program; currentProgramLabel = opt.textContent.replace(/^Program:\s*/,''); }
    else { programSel.value = '__current__'; currentProgramLabel = initialParams.program; }
    loadProgram(programSel.value, currentProgramLabel).catch(function(err){ alert(err.message); });
  } else {
    programSel.value = 'porsche_residuals_all.json';
    loadProgram(programSel.value, 'PB 25-10R (Default)').catch(function(){
      programSel.value = '__current__';
      loadProgram('__current__', 'Current').catch(function(err){ alert(err.message); });
    });
  }
})();
</script>
</body>
</html>

<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Residual Pro ‚Äî By Ricardo</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0e1a">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #050810;
    --bg-secondary: #0a0e1a;
    --card: rgba(255, 255, 255, 0.02);
    --card-hover: rgba(255, 255, 255, 0.05);
    --text: #e8edf5;
    --text-primary: #ffffff;
    --muted: #7c8ba1;
    --border: rgba(255, 255, 255, 0.06);
    --border-hover: rgba(59, 130, 246, 0.3);
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --accent-glow: rgba(59, 130, 246, 0.4);
    --success: #10b981;
    --success-glow: rgba(16, 185, 129, 0.3);
    --danger: #ef4444;
    --warning: #f59e0b;
    --purple: #8b5cf6;
    --purple-glow: rgba(139, 92, 246, 0.3);
    --radius: 20px;
    --radius-sm: 12px;
    --shadow: 0 20px 60px rgba(0,0,0,0.6);
    --shadow-lg: 0 30px 80px rgba(0,0,0,0.8);
    --glow: 0 0 40px var(--accent-glow);
    --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  [data-theme="light"]{
    --bg: #f5f7fa;
    --bg-secondary: #ffffff;
    --card: #ffffff;
    --card-hover: #f8fafc;
    --text: #1e293b;
    --text-primary: #0f172a;
    --muted: #64748b;
    --border: #e2e8f0;
    --border-hover: rgba(59, 130, 246, 0.4);
    --shadow: 0 10px 40px rgba(15,23,42,0.1);
    --shadow-lg: 0 20px 60px rgba(15,23,42,0.15);
    --glow: 0 0 40px rgba(59, 130, 246, 0.15);
    --accent-glow: rgba(59, 130, 246, 0.2);
    --success-glow: rgba(16, 185, 129, 0.2);
    --purple-glow: rgba(139, 92, 246, 0.2);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  @keyframes gradientShift { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-20px)} }
  @keyframes slideInFromTop { from{transform:translateY(-30px);opacity:0} to{transform:translateY(0);opacity:1} }
  @keyframes fadeInUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
  @keyframes scaleIn { from{transform:scale(.9);opacity:0} to{transform:scale(1);opacity:1} }
  @keyframes shimmer { 0%{background-position:-1000px 0} 100%{background-position:1000px 0} }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.6} }
  html, body{
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 16px;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-height: 100vh;
    overflow-x: hidden;
  }
  body {
    background: linear-gradient(135deg, var(--bg) 0%, var(--bg-secondary) 50%, var(--bg) 100%);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
  }
  .wrap { max-width: 980px; margin: 0 auto; padding: 20px 20px 100px; position: relative; }
  body::before{
    content:''; position:fixed; top:-50%; left:-50%; width:200%; height:200%;
    background: radial-gradient(circle at 30% 20%, var(--accent-glow) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, var(--purple-glow) 0%, transparent 50%);
    opacity:.4; pointer-events:none; z-index:0; animation: float 20s ease-in-out infinite;
  }
  body::after{ content:''; position:fixed; inset:0; background:linear-gradient(90deg,transparent 0%, rgba(59,130,246,.03) 50%, transparent 100%); pointer-events:none; z-index:0; }
  .wrap > * { position: relative; z-index: 1; }

  .top { position:sticky; top:0; z-index:50; backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%);
         background: rgba(255,255,255,.82); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; margin-bottom: 24px; box-shadow: var(--shadow); animation: slideInFromTop .6s ease; }
  [data-theme="dark"] .top { background: rgba(255,255,255,.06); }

  .brand{ display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .leftRow{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

  .pill{
    display:inline-flex; align-items:center; gap:12px; background:linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
    background-size:200% 200%; animation:gradientShift 8s ease infinite; color:#fff; padding:12px 24px; border-radius:999px;
    font-weight:900; font-size:.95rem; letter-spacing:.5px; box-shadow:0 8px 30px var(--accent-glow); white-space:nowrap; transition:var(--transition); position:relative; overflow:hidden;
  }
  .pill::before{ content:''; position:absolute; inset:0; left:-100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent); animation:shimmer 3s infinite; }
  .theme,.btn{
    border:1px solid var(--border); background:var(--card); backdrop-filter:blur(10px); color:var(--text); padding:10px 18px; border-radius:var(--radius-sm); cursor:pointer;
    font-weight:600; font-size:.9rem; transition:var(--transition); white-space:nowrap; position:relative; overflow:hidden;
  }
  .theme:hover,.btn:hover{ background:var(--card-hover); border-color:var(--border-hover); transform:translateY(-2px); box-shadow:0 8px 25px var(--accent-glow); }
  .select{ min-width:200px; transition:var(--transition); }
  .select:hover{ transform:scale(1.02); }

  .card{ background:var(--card); backdrop-filter:blur(30px) saturate(180%); -webkit-backdrop-filter:blur(30px) saturate(180%);
         border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:28px; transition:var(--transition); animation:fadeInUp .6s ease; position:relative; overflow:hidden; }
  .card:hover{ border-color:var(--border-hover); box-shadow:var(--shadow-lg), var(--glow); transform:translateY(-5px); }
  .controls{ position:sticky; top:100px; z-index:20; }
  @media (max-width:900px){ .controls{ position:static; } }

  .grid{ display:grid; gap:18px; }
  .g4{ grid-template-columns:repeat(4,minmax(0,1fr)); }
  .g3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
  .g2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
  @media (max-width:900px){ .g4,.g3,.g2{ grid-template-columns:1fr; } }

  label{ font-size:.75rem; color:var(--muted); display:block; margin:0 0 10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; }
  select,input[type="number"],input[type="text"]{
    width:100%; appearance:none; -webkit-appearance:none; background:var(--bg-secondary);
    color:var(--text); border:2px solid var(--border); border-radius:var(--radius-sm); padding:14px 18px; font-size:.95rem; font-weight:500; transition:var(--transition);
  }
  select:focus,input:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 4px var(--accent-glow); background:var(--card); transform:translateY(-2px); }
  select{
    cursor:pointer; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:right 14px center; padding-right:45px;
  }
  .muted{ color:var(--muted); }
  .rowline{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; }

  .result{ display:flex; align-items:baseline; gap:20px; margin:24px 0 20px; flex-wrap:wrap; padding:24px; border-radius:16px; border:2px solid var(--border-hover); }
  .result .big{ font-size:3.4rem; font-weight:900; letter-spacing:-1px; background:linear-gradient(135deg,var(--accent),var(--purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
  .result .small{ font-size:1rem; font-weight:600; }

  .tableWrap{ margin-top:20px; overflow-x:auto; -webkit-overflow-scrolling:touch; border:1px solid var(--border); border-radius:var(--radius); background:var(--bg-secondary); }
  table{ min-width:720px; width:100%; border-collapse:separate; border-spacing:0; }
  th,td{ padding:14px 16px; border-bottom:1px solid var(--border); text-align:left; white-space:nowrap; }
  thead th{ font-size:.75rem; color:var(--muted); font-weight:800; position:sticky; top:0; background:var(--card); z-index:1; text-transform:uppercase; letter-spacing:1px; border-bottom:2px solid var(--border-hover); }
  td.ok{ color:var(--success); font-weight:800; }
  td.err{ color:var(--danger); opacity:.6; }
  td:first-child,th:first-child{ position:sticky; left:0; background:var(--card); z-index:2; font-weight:800; }

  .summary{ margin-top:20px; padding:24px; border:2px solid var(--border-hover); border-radius:16px; background:var(--card); }
  .sum-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; margin-top:16px; }
  @media (max-width:700px){ .sum-grid{ grid-template-columns:1fr; } }
  .srow{ display:flex; gap:12px; align-items:center; justify-content:space-between; background:linear-gradient(135deg, rgba(59,130,246,.06), rgba(139,92,246,.06)); border:1px solid var(--border); border-radius:12px; padding:12px 14px; }
  .slabel{ font-weight:700; color:var(--muted); font-size:.9rem; }
  .sval{ font-variant-numeric:tabular-nums; font-weight:800; font-size:1.05rem; color:var(--text-primary); }
  .badge{ background:linear-gradient(135deg, rgba(59,130,246,.18), rgba(139,92,246,.1)); border:1px solid var(--border-hover); padding:8px 14px; border-radius:999px; font-size:.8rem; font-weight:700; margin-right:8px; }

  /* Lease Estimator compact tweaks for iPhone */
  @media (max-width:375px){
    .card{ padding:18px; border-radius:14px; }
    .result{ padding:16px; border-radius:12px; }
  }

  /* Sniffer */
  .sniff-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .sniff-title{font-weight:900;letter-spacing:.3px;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .sniff-grid{display:grid;grid-template-columns:1fr;gap:10px}
  .sniff-card{border:2px solid var(--border);border-radius:14px;background:var(--bg-secondary);padding:12px;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
  .sniff-card:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.08)}
  .sniff-best{border-color:rgba(16,185,129,.35);box-shadow:0 0 0 3px rgba(16,185,129,.12)}
  .sniff-top{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:6px}
  .pill-mini{padding:5px 10px;border-radius:999px;border:1px solid var(--border-hover);background:var(--card);font-weight:800;font-size:.82rem}
  .sniff-rows{display:flex;gap:12px;flex-wrap:wrap}
  .sniff-rows .label{color:var(--muted);font-size:.85rem}
  .sniff-rows .val{font-weight:800}
  .sniff-foot{display:flex;align-items:center;justify-content:space-between;margin-top:6px}
  .sniff-apply{visibility:hidden;font-size:.82rem}
  .sniff-card:hover .sniff-apply{visibility:visible}

  @media (max-width:375px){
    .sniff-card{padding:10px;border-radius:12px}
    .pill-mini{padding:4px 8px;font-size:.78rem}
    .sniff-rows{flex-direction:column;gap:4px}
  }

  .footer{ margin:40px 0 20px; }
  .foot-card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:28px 32px; text-align:center; }
  .foot-title{ font-weight:900; letter-spacing:.5px; margin-bottom:12px; font-size:1.2rem; background:linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
  .foot-text{ color:var(--muted); font-size:.95rem; line-height:1.8; }

  @media print{
    .top,.controls,.tableWrap,#leaseCard,#snifferCard,#validatorCard,.footer{ display:none !important; }
    .summary{ border:0; box-shadow:none; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="leftRow">
          <div class="pill">‚ö° Residual Pro ‚Äî By Ricardo</div>
          <select id="programSel" class="select">
            <option value="porsche_residuals_all.json">Program: PB 25-10R (Default)</option>
            <option value="porsche_residuals_25-09R.json">Program: PB 25-09R (Oct)</option>
          </select>
        </div>
        <div class="leftRow">
          <button id="jumpSummaryBtn" class="btn" type="button">üìä Summary</button>
          <button id="validateBtn" class="btn" type="button">‚úì Validate</button>
          <button id="exportCsvBtn" class="btn" type="button">üì• Export</button>
          <button id="printBtn" class="btn" type="button">üñ®Ô∏è Print</button>
          <button id="themeBtn" class="theme" type="button">üåô Dark</button>
        </div>
      </div>
    </div>

    <div class="card controls" id="controls">
      <div class="grid g4">
        <div>
          <label>üöó Model Family</label>
          <select id="familySel"></select>
        </div>
        <div>
          <label>üìÖ Model Year</label>
          <select id="yearSel"></select>
        </div>
        <div>
          <label>üéØ Trim</label>
          <select id="trimSel"></select>
          <div class="muted" id="trimCount" style="font-size:.85rem;margin-top:6px"></div>
        </div>
        <div>
          <label>üîç Search Trim</label>
          <input id="trimSearch" type="text" placeholder="Type to filter..." />
        </div>
      </div>

      <div class="grid g3" style="margin-top: 16px">
        <div>
          <label>‚è±Ô∏è Term (months)</label>
          <select id="termSel"></select>
        </div>
        <div>
          <label>üìä Miles per Year</label>
          <select id="annualMilesSel"></select>
        </div>
        <div class="rowline" style="margin-top: 32px">
          <label class="rowline" style="gap: 10px;">
            <input id="pacpoToggle" type="checkbox" />
            <span>+2% PACPO</span>
          </label>
          <label class="rowline" style="gap: 10px;">
            <input id="hideNA" type="checkbox" />
            <span>Hide N/A</span>
          </label>
          <div class="pill" id="codeBadge" style="font-size:0.85rem;padding:8px 16px;">Code: ‚Äî</div>
        </div>
      </div>

      <div class="grid g3" style="margin-top: 16px">
        <div>
          <label>üõ£Ô∏è Miles at Inception</label>
          <input id="odoInput" type="number" min="0" step="1" placeholder="e.g., 3,450" />
        </div>
        <div>
          <label>üí∞ MSRP ($)</label>
          <input id="msrpInput" type="number" min="0" step="100" placeholder="e.g., 142,000" />
        </div>
        <div>
          <label>üîó Shareable Link</label>
          <input id="shareLink" type="text" readonly style="font-size:0.85rem;" />
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 20px;">
      <div class="result">
        <div class="big" id="finalOut">‚Äî</div>
        <div class="small muted" id="detailOut">Select options to calculate</div>
        <div class="small" id="trueOut" style="font-weight:800;"></div>
        <div class="small muted" id="lviBadge" style="font-weight:700;"></div>
      </div>

      <div class="tableWrap">
        <table id="residualTable">
          <thead><tr id="theadRow"></tr></thead>
          <tbody><tr id="tvalRow"></tr></tbody>
        </table>
      </div>

      <div class="summary" id="summaryBox">
        <div class="rowline" style="justify-content:space-between;">
          <strong style="font-size:1.2rem;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">üìã Summary</strong>
          <button id="copyBtn" class="theme btn" type="button">üìÑ Copy</button>
        </div>

        <div class="srow" style="margin-top:16px; border:3px solid var(--accent)">
          <span class="slabel" style="color:var(--accent);">Final Residual</span>
          <span class="sval" id="sumFinal" style="font-size:1.4rem;color:var(--accent);font-weight:900;">‚Äî</span>
        </div>

        <div class="sum-grid">
          <div class="srow"><span class="slabel">Program</span><span class="sval" id="sumProgram">‚Äî</span></div>
          <div class="srow"><span class="slabel">Model Year</span><span class="sval" id="sumYear">‚Äî</span></div>
          <div class="srow"><span class="slabel">Family</span><span class="sval" id="sumFamily">‚Äî</span></div>
          <div class="srow"><span class="slabel">Trim</span><span class="sval" id="sumTrim">‚Äî</span></div>
          <div class="srow"><span class="slabel">Term</span><span class="sval" id="sumTerm">‚Äî</span></div>
          <div class="srow"><span class="slabel">Miles/Year</span><span class="sval" id="sumMilesYear">‚Äî</span></div>
          <div class="srow"><span class="slabel">Odometer</span><span class="sval" id="sumOdo">‚Äî</span></div>
          <div class="srow"><span class="slabel">MSRP √ó RV%</span><span class="sval" id="sumTrue">‚Äî</span></div>
          <div class="srow"><span class="slabel">Value Index</span><span class="sval" id="sumLvi">‚Äî</span></div>
        </div>

        <div id="badgeRow" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px"></div>
      </div>
    </div>

    <!-- Lease Estimator -->
    <div class="card" id="leaseCard" style="margin-top: 20px;">
      <div class="rowline" style="justify-content:space-between; margin-bottom:16px;">
        <strong style="font-size:1.2rem;background:linear-gradient(135deg,var(--success),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">üí≥ Lease Estimator</strong>
        <span class="muted" style="font-size:0.95rem;font-style:italic;">Uses current RV% & term</span>
      </div>

      <div class="grid g3">
        <div>
          <label>üíµ Cap Cost ($)</label>
          <input id="leaseCapCost" type="number" min="0" step="100" placeholder="e.g., 165000" />
          <div class="muted" style="font-size:.85rem;margin-top:4px">Selling price before down</div>
        </div>
        <div>
          <label>üìà Money Factor</label>
          <input id="leaseMF" type="number" min="0" step="0.00001" placeholder="e.g., 0.00210" />
          <div class="muted" id="mfAprHint" style="font-size:.85rem;margin-top:4px"></div>
        </div>
        <div>
          <label>üßæ Tax Rate (%)</label>
          <input id="leaseTax" type="number" min="0" step="0.01" placeholder="e.g., 9.375" />
        </div>
      </div>

      <div class="grid g3" style="margin-top:14px">
        <div>
          <label>üí∏ Cap Reduction ($)</label>
          <input id="leaseCapReduction" type="number" min="0" step="100" placeholder="0" />
          <div class="muted" style="font-size:.85rem;margin-top:4px">Cash down (optional)</div>
        </div>
        <div>
          <label>üìù Rolled Fees ($)</label>
          <input id="leaseFees" type="number" min="0" step="25" placeholder="0" />
          <div class="muted" style="font-size:.85rem;margin-top:4px">Acq/Doc fees (optional)</div>
        </div>
        <div>
          <label>‚è∞ Term (mo)</label>
          <input id="leaseTerm" type="number" min="12" step="1" placeholder="auto" />
          <div class="muted" style="font-size:.85rem;margin-top:4px">Auto-fills from selection; manual edits persist</div>
        </div>
      </div>

      <div class="grid g3" style="margin-top:16px">
        <div class="srow"><span class="slabel">Residual %</span><span class="sval" id="leaseRvPct">‚Äî</span></div>
        <div class="srow"><span class="slabel">Residual $</span><span class="sval" id="leaseRvAmt">‚Äî</span></div>
        <div class="srow"><span class="slabel">Adj Cap Cost</span><span class="sval" id="leaseAdjCap">‚Äî</span></div>
      </div>

      <div class="grid g2" style="margin-top:16px">
        <div class="srow" style="border:2px solid var(--success);"><span class="slabel" style="color:var(--success);">Monthly (Pre-Tax)</span><span class="sval" id="leasePreTax" style="color:var(--success);font-size:1.15rem;">‚Äî</span></div>
        <div class="srow" style="border:2px solid var(--purple);"><span class="slabel" style="color:var(--purple);">Monthly (With Tax)</span><span class="sval" id="leaseWithTax" style="color:var(--purple);font-size:1.15rem;">‚Äî</span></div>
      </div>
    </div>

    <!-- Lease Sniffer -->
    <div class="card" id="snifferCard" style="margin-top:16px;">
      <div class="sniff-header">
        <div class="sniff-title">üîç Lease Sniffer ‚Äî Best Alternative Terms</div>
        <div class="muted" style="font-size:.9rem">Ranks by LVI ‚Üí With‚ÄëTax Payment</div>
      </div>
      <div id="sniffGrid" class="sniff-grid"></div>
      <div class="muted" id="sniffHint" style="margin-top:8px;font-size:.85rem;">Auto-updates as you change any field. Tap a card to apply its term.</div>
    </div>

    <div class="card" id="validatorCard" style="margin-top:16px; display:none;">
      <div class="rowline" style="justify-content:space-between; margin-bottom:12px;">
        <strong style="font-size:1.1rem;">üîç JSON Validator</strong>
        <button id="closeValBtn" class="btn" type="button">‚úï Close</button>
      </div>
      <div id="validatorOutput" class="muted" style="font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:0.9rem; line-height:1.8;"></div>
    </div>

    <div class="footer">
      <div class="foot-card">
        <div class="foot-title">‚ú® Crafted by Ricardo</div>
        <div class="foot-text">
          ¬© Ricardo. This internal tool is confidential and intended for authorized use only.
          <br>Do not share, copy, or redistribute without written permission.
          <br><strong>Built with precision. Used with trust.</strong>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // -------- PWA icon + manifest (kept intact) --------
  (function generateIconsAndManifest(){
    try{
      var canvas = document.createElement('canvas');
      canvas.width = canvas.height = 512;
      var ctx = canvas.getContext('2d');
      var grad = ctx.createLinearGradient(0,0,512,512);
      grad.addColorStop(0,'#3b82f6'); grad.addColorStop(1,'#8b5cf6');
      ctx.fillStyle = grad; ctx.fillRect(0,0,512,512);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 280px Inter, Arial, sans-serif';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText('R', 256, 270);
      canvas.toBlob(function(blob){
        if(!blob) return;
        var iconURL = URL.createObjectURL(blob);
        var linkApple = document.createElement('link'); linkApple.rel = 'apple-touch-icon'; linkApple.href = iconURL;
        document.head.appendChild(linkApple);
        var manifest = {
          name: "Residual Pro ‚Äî By Ricardo",
          short_name: "Residual Pro",
          start_url: ".",
          display: "standalone",
          background_color: "#050810",
          theme_color: "#3b82f6",
          icons: [{ src: iconURL, sizes: "512x512", type: "image/png", purpose: "any maskable" }]
        };
        var blobMan = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
        var manURL = URL.createObjectURL(blobMan);
        var linkMan = document.createElement('link'); linkMan.rel = 'manifest'; linkMan.href = manURL;
        document.head.appendChild(linkMan);
      }, 'image/png');
    }catch(e){}
  })();

  // -------- Theme (default light, preserves glow) --------
  var themeBtn = document.getElementById('themeBtn');
  document.documentElement.setAttribute('data-theme', 'light');
  themeBtn.innerHTML = 'üåô Dark';
  themeBtn.addEventListener('click', function(){
    var cur = document.documentElement.getAttribute('data-theme');
    var next = cur === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    themeBtn.innerHTML = next === 'light' ? 'üåô Dark' : '‚òÄÔ∏è Light';
    themeBtn.classList.add('success-flash');
    setTimeout(function(){ themeBtn.classList.remove('success-flash'); }, 600);
  });

  // -------- DOM refs --------
  var programSel = document.getElementById('programSel');
  var validateBtn = document.getElementById('validateBtn');
  var exportCsvBtn = document.getElementById('exportCsvBtn');
  var printBtn = document.getElementById('printBtn');
  var jumpSummaryBtn = document.getElementById('jumpSummaryBtn');
  var familySel = document.getElementById('familySel');
  var yearSel = document.getElementById('yearSel');
  var trimSel = document.getElementById('trimSel');
  var trimSearch = document.getElementById('trimSearch');
  var trimCount = document.getElementById('trimCount');
  var termSel = document.getElementById('termSel');
  var pacpoToggle = document.getElementById('pacpoToggle');
  var hideNA = document.getElementById('hideNA');
  var codeBadge = document.getElementById('codeBadge');
  var finalOut = document.getElementById('finalOut');
  var detailOut = document.getElementById('detailOut');
  var trueOut = document.getElementById('trueOut');
  var theadRow = document.getElementById('theadRow');
  var tvalRow = document.getElementById('tvalRow');
  var annualMilesSel = document.getElementById('annualMilesSel');
  var odoInput = document.getElementById('odoInput');
  var msrpInput = document.getElementById('msrpInput');
  var shareLink = document.getElementById('shareLink');
  var sumProgram = document.getElementById('sumProgram');
  var sumYear = document.getElementById('sumYear');
  var sumFamily = document.getElementById('sumFamily');
  var sumTrim = document.getElementById('sumTrim');
  var sumTerm = document.getElementById('sumTerm');
  var sumMilesYear = document.getElementById('sumMilesYear');
  var sumOdo = document.getElementById('sumOdo');
  var sumMsrp = document.getElementById('sumMsrp');
  var sumTrue = document.getElementById('sumTrue');
  var sumFinal = document.getElementById('sumFinal');
  var badgeRow = document.getElementById('badgeRow');
  var copyBtn = document.getElementById('copyBtn');
  var leaseCapCost = document.getElementById('leaseCapCost');
  var leaseMF = document.getElementById('leaseMF');
  var leaseTax = document.getElementById('leaseTax');
  var leaseCapReduction = document.getElementById('leaseCapReduction');
  var leaseFees = document.getElementById('leaseFees');
  var leaseTerm = document.getElementById('leaseTerm');
  var leaseRvPct = document.getElementById('leaseRvPct');
  var leaseRvAmt = document.getElementById('leaseRvAmt');
  var leaseAdjCap = document.getElementById('leaseAdjCap');
  var leasePreTax = document.getElementById('leasePreTax');
  var leaseWithTax = document.getElementById('leaseWithTax');
  var mfAprHint = document.getElementById('mfAprHint');
  var lviBadge = document.getElementById('lviBadge');
  var sumLvi = document.getElementById('sumLvi');
  var validatorCard = document.getElementById('validatorCard');
  var closeValBtn = document.getElementById('closeValBtn');
  var validatorOutput = document.getElementById('validatorOutput');
  var sniffGrid = document.getElementById('sniffGrid');

  var data, MONTHS = [], PACPO = 2;
  var fullTrimList = [];
  var currentProgramLabel = 'PB 25-10R (Default)';
  var leaseTermDirty = false; // respect manual term edits

  function readParams(){
    var p = new URLSearchParams(location.search);
    return {
      program: p.get('data') || null, family: p.get('family') || null, year: p.get('year') || null,
      trim: p.get('trim') || null, term: p.get('term') || null, miles: p.get('miles') || null,
      odo: p.get('odo') || null, pacpo: p.get('pacpo') || null, hidena: p.get('hidena') || null,
      msrp: p.get('msrp') || null
    };
  }
  function updateShareURL(){
    var p = new URLSearchParams();
    var program = programSel.value || 'porsche_residuals_all.json';
    p.set('data', program);
    if(familySel.value) p.set('family', familySel.value);
    if(yearSel.value) p.set('year', yearSel.value);
    if(trimSel.value) p.set('trim', trimSel.value);
    if(termSel.value) p.set('term', termSel.value);
    if(annualMilesSel.value) p.set('miles', annualMilesSel.value);
    if(odoInput.value) p.set('odo', odoInput.value);
    if(pacpoToggle.checked) p.set('pacpo', '1');
    if(hideNA.checked) p.set('hidena', '1');
    if(msrpInput.value) p.set('msrp', msrpInput.value);
    var url = location.pathname + '?' + p.toString();
    shareLink.value = location.origin + url;
    history.replaceState(null, '', url);
  }

  function normalizeYearKey(k){
    var s = String(k).trim();
    var mPlain = s.match(/^(20\\d{2})$/); if (mPlain) return { display: 'MY' + mPlain[1].slice(-2), key: k };
    var mMY = s.toUpperCase().replace(/\\s+/g,'').match(/^MY(\\d{2})$/); if (mMY) return { display: 'MY' + mMY[1], key: k };
    return { display: s, key: k };
  }
  function getCaseInsensitive(obj, name){
    if(!obj || typeof obj !== "object") return undefined;
    var target = String(name).replace(/\\s+/g,'').toLowerCase();
    var keys = Object.keys(obj);
    for(var i=0;i<keys.length;i++){ if(keys[i].replace(/\\s+/g,'').toLowerCase() === target) return obj[keys[i]]; }
    return undefined;
  }
  function getVirtualFamilies(){
    var out = new Set();
    var models = data.models || {};
    Object.keys(models).forEach(function(f){
      if(f === '718'){
        var cay = getCaseInsensitive(models['718'],'Cayman');
        var box = getCaseInsensitive(models['718'],'Boxster');
        if (cay) out.add('718 Cayman'); if (box) out.add('718 Boxster');
      } else { out.add(f); }
    });
    if(models['Cayman']) out.add('718 Cayman');
    if(models['Boxster']) out.add('718 Boxster');
    var order = ['911','718 Cayman','718 Boxster','Taycan','Macan','Cayenne','Panamera'];
    return Array.from(out).sort(function(a,b){ return order.indexOf(a) - order.indexOf(b); });
  }
  function branchForFamily(famDisp){
    var models = data.models || {};
    if (famDisp === '718 Cayman') return getCaseInsensitive(models['718']||{}, 'Cayman') || models['Cayman'] || {};
    if (famDisp === '718 Boxster') return getCaseInsensitive(models['718']||{}, 'Boxster') || models['Boxster'] || {};
    return models[famDisp] || {};
  }
  function yearsForFamily(famDisp){
    var out = new Set(); var branch = branchForFamily(famDisp);
    Object.keys(branch).forEach(function(k){ out.add(normalizeYearKey(k).display); });
    return Array.from(out).sort(function(a,b){
      var ay = parseInt(a.replace(/\\D/g,''),10), by = parseInt(b.replace(/\\D/g,''),10);
      if (isNaN(ay) || isNaN(by)) return b.localeCompare(a);
      return by - ay;
    });
  }
  function populate(select, arr){
    select.innerHTML = '';
    arr.forEach(function(v){ var opt = document.createElement('option'); opt.value = v; opt.textContent = v; select.appendChild(opt); });
  }
  function initSelectors(){
    populate(familySel, getVirtualFamilies());
    populate(yearSel, yearsForFamily(familySel.value));
    termSel.innerHTML = '';
    MONTHS.forEach(function(m){ var opt = document.createElement('option'); opt.value = m; opt.textContent = m + ' months'; termSel.appendChild(opt); });
    populateAnnualMiles();
    collectTrimsForYear();
    populateTrims('');
  }
  function populateAnnualMiles(){
    annualMilesSel.innerHTML = '';
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {
      "2500":6,"5000":5,"7500":4,"10000":3,"12000":2,"15000":0
    };
    Object.keys(milesMap).map(function(k){ return parseInt(k,10); }).sort(function(a,b){ return a-b; })
      .forEach(function(n){ var opt = document.createElement('option'); opt.value = String(n); opt.textContent = n.toLocaleString() + ' mi/yr'; annualMilesSel.appendChild(opt); });
    annualMilesSel.value = "15000";
  }
  function collectTrimsForYear(){
    fullTrimList = [];
    var branch = branchForFamily(familySel.value);
    var dispYear = yearSel.value;
    var yearKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    var rows = (yearKey && branch[yearKey]) || {};
    Object.entries(rows).forEach(function(entry){ fullTrimList.push({code: entry[0], model: entry[1].model || entry[0]}); });
  }
  function populateTrims(filterTerm){
    trimSel.innerHTML = '';
    var term = (filterTerm||'').trim().toLowerCase();
    var filtered = fullTrimList.filter(function(t){ return (t.model + " " + t.code).toLowerCase().indexOf(term) !== -1; });
    filtered.forEach(function(item){ var opt = document.createElement('option'); opt.value = item.code; opt.textContent = item.model; opt.dataset.code = item.code; trimSel.appendChild(opt); });
    trimCount.textContent = filtered.length ? (filtered.length + ' trim(s) available') : 'No matches';
  }
  function parseRange(str){
    if(!str) return null;
    var s = str.replace(/,/g,'').replace(/\\s/g,'');
    var parts = s.split(/‚Äì|-/); if(parts.length !== 2) return null;
    var a = parseInt(parts[0],10), b = parseInt(parts[1],10);
    if(isNaN(a) || isNaN(b)) return null;
    return [a,b];
  }
  function findInceptionAdj(myKey, odo){
    var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[myKey]) || null;
    if(!bands || odo == null) return 0;
    for(var i=0;i<bands.length;i++){
      var rng = parseRange(bands[i].miles_range); if(!rng) continue;
      if(odo >= rng[0] && odo <= rng[1]) return bands[i].adj || 0;
    }
    return 0;
  }
  function visibleMonthsFor(entry){
    if(!hideNA.checked) return MONTHS.slice();
    var result = [];
    for(var i=0;i<MONTHS.length;i++){ if(entry && entry.residuals && entry.residuals[MONTHS[i]] != null) result.push(MONTHS[i]); }
    return result;
  }
  function buildHeader(visibleMonths){
    theadRow.innerHTML = '';
    var th1 = document.createElement('th'); th1.textContent = 'Trim / Term'; theadRow.appendChild(th1);
    visibleMonths.forEach(function(m){ var th = document.createElement('th'); th.textContent = m + ' mo'; theadRow.appendChild(th); });
  }
  function computeLVI(rvPercent, mf){ if(!isFinite(rvPercent) || !isFinite(mf) || mf <= 0) return null; return rvPercent / mf; }

  // ------- Main compute (Final residual + UI) -------
  function compute(){
    var fam = familySel.value;
    var branch = branchForFamily(fam);
    var dispYear = yearSel.value;
    var yrKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    var code = trimSel.value;
    var term = termSel.value;
    var milesPerYear = parseInt(annualMilesSel.value, 10);
    var odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''), 10) : null;

    if(!yrKey || !code){
      finalOut.textContent = '‚Äî';
      detailOut.textContent = 'Select family/year/trim';
      trueOut.textContent = '';
      if(lviBadge) lviBadge.textContent = '';
      if(sumLvi) sumLvi.textContent = '‚Äî';
      updateShareURL();
      renderSniffer([]); // clear
      return;
    }

    var entry = branch[yrKey][code];
    var base = term ? ((entry && entry.residuals && entry.residuals[term]) || null) : null;
    var pacpoAdj = pacpoToggle.checked ? (data.pacpo_bonus_percent || 2) : 0;
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    var annualAdj = 0;
    if(base !== null && parseInt(term || "0", 10) >= 24){ annualAdj = milesMap[String(milesPerYear)] || 0; }

    // Inception (mileage at inception) ‚Äî try several keys to cover MY22/MY23 Cayenne naming variants
    var inceptionAdj = 0;
    var inceptionKeyCandidates = [yrKey, dispYear, dispYear.replace(/\\s+/g,'')];
    for(var i=0;i<inceptionKeyCandidates.length;i++){
      var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[inceptionKeyCandidates[i]]) || null;
      if(bands){ inceptionAdj = findInceptionAdj(inceptionKeyCandidates[i], odo); break; }
    }

    var monthsShown = visibleMonthsFor(entry);
    buildHeader(monthsShown);

    var final = (base === null || term == null) ? null : (base + pacpoAdj + annualAdj + inceptionAdj);
    finalOut.textContent = final === null ? '‚Äî' : final + '%';
    detailOut.textContent = final === null ? 'Select a term' : 'Final with all adjustments';
    codeBadge.textContent = 'Code: ' + (code || '‚Äî');

    tvalRow.innerHTML = '';
    var lead = document.createElement('td'); lead.textContent = (entry && entry.model) || '‚Äî'; tvalRow.appendChild(lead);
    monthsShown.forEach(function(m){
      var td = document.createElement('td');
      var v = entry && entry.residuals && entry.residuals[m];
      var shown = '‚Äî';
      if(v !== null && v !== undefined){
        var mN = parseInt(m, 10);
        var aAdj = (mN >= 24) ? (milesMap[String(milesPerYear)] || 0) : 0;
        var total = v + pacpoAdj + aAdj + inceptionAdj;
        shown = total + '%'; td.classList.add('ok');
      } else { td.classList.add('err'); }
      td.textContent = shown; tvalRow.appendChild(td);
    });

    // Summary
    sumProgram.textContent = currentProgramLabel;
    sumYear.textContent = dispYear || '‚Äî';
    sumFamily.textContent = fam || '‚Äî';
    sumTrim.textContent = (entry && entry.model) || '‚Äî';
    sumTerm.textContent = term ? (term + ' mo') : '‚Äî';
    sumMilesYear.textContent = Number.isFinite(milesPerYear) ? milesPerYear.toLocaleString() + ' mi/yr' : '‚Äî';
    sumOdo.textContent = (odo != null && !isNaN(odo)) ? odo.toLocaleString() + ' mi' : '‚Äî';

    var msrp = msrpInput.value ? Number(msrpInput.value) : null;
    if (sumMsrp) sumMsrp.textContent = (msrp != null && !isNaN(msrp)) ? ('$' + msrp.toLocaleString()) : '‚Äî';
    var trueResidual = (final != null && msrp != null && !isNaN(msrp)) ? Math.round(msrp * (final/100)) : null;
    sumTrue.textContent = (trueResidual != null) ? ('$' + trueResidual.toLocaleString()) : '‚Äî';

    trueOut.innerHTML = (trueResidual != null)
      ? ('<span style="color:#bfa7ff;font-weight:700">MSRP √ó RV% = </span><span style="font-weight:800;color:var(--text-primary)">$' + trueResidual.toLocaleString() + '</span>')
      : '';

    // Badges
    badgeRow.innerHTML = '';
    if(base !== null && term){ addBadge('Base ' + base + '%'); }
    if(pacpoToggle.checked){ addBadge('+' + (data.pacpo_bonus_percent || 2) + '% PACPO'); }
    if(term && parseInt(term, 10) >= 24 && annualAdj){ addBadge(((annualAdj>=0?'+':'') + annualAdj + '%') + ' Annual'); }
    if(odo != null && !isNaN(odo) && inceptionAdj){ addBadge(((inceptionAdj>=0?'+':'') + inceptionAdj + '%') + ' Inception'); }

    sumFinal.textContent = final === null ? '‚Äî' : final + '%';

    // LVI
    var mfVal = leaseMF && leaseMF.value ? Number(leaseMF.value) : NaN;
    var lviCurrent = computeLVI(final, mfVal);
    if(lviCurrent != null){
      var lviText = (lviCurrent/1000).toFixed(1) + 'k';
      if(lviBadge) lviBadge.textContent = 'LVI: ' + lviText;
      if(sumLvi) sumLvi.textContent = lviText;
    } else {
      if(lviBadge) lviBadge.textContent = '';
      if(sumLvi) sumLvi.textContent = '‚Äî';
    }

    // Share & Estimator
    updateShareURL();
    if(leaseTerm && (!leaseTerm.value || leaseTerm.value === '') && termSel && termSel.value && !leaseTermDirty) {
      leaseTerm.value = termSel.value;
    }
    leaseCompute();
    runSniffer(); // auto-run on every compute
  }

  function addBadge(txt){
    var b = document.createElement('div'); b.className = 'badge'; b.textContent = txt; badgeRow.appendChild(b);
  }
  function exportVisibleCSV(){
    var fam = familySel.value;
    var branch = branchForFamily(fam);
    var dispYear = yearSel.value;
    var yrKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    if(!yrKey || !trimSel.value){ alert('Select family/year/trim first.'); return; }
    var entry = branch[yrKey][trimSel.value];
    var monthsShown = visibleMonthsFor(entry);
    var rows = [];
    rows.push(['Trim/Term'].concat(monthsShown.map(function(m){return m + ' mo';})));
    var line = [(entry && entry.model) || '‚Äî'];
    var milesPerYear = parseInt(annualMilesSel.value, 10);
    var pacpoAdj = pacpoToggle.checked ? (data.pacpo_bonus_percent || 2) : 0;
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    var inceptionKeyCandidates = [yrKey, dispYear, dispYear.replace(/\\s+/g,'')];
    var inceptionAdj = 0;
    var odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''), 10) : null;
    for(var i=0;i<inceptionKeyCandidates.length;i++){
      var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[inceptionKeyCandidates[i]]) || null;
      if(bands){ inceptionAdj = findInceptionAdj(inceptionKeyCandidates[i], odo); break; }
    }
    monthsShown.forEach(function(m){
      var v = entry && entry.residuals && entry.residuals[m];
      if(v==null){ line.push(''); return; }
      var aAdj = (parseInt(m,10) >= 24) ? (milesMap[String(milesPerYear)] || 0) : 0;
      var total = v + pacpoAdj + aAdj + inceptionAdj;
      line.push(total + '%');
    });
    rows.push(line);
    rows.push([]);
    rows.push(['Program', currentProgramLabel]);
    rows.push(['Year', dispYear], ['Family', fam], ['Trim', (entry && entry.model)||'‚Äî'], ['Term', termSel.value ? termSel.value+' mo':'‚Äî']);
    rows.push(['Miles/Year', sumMilesYear.textContent], ['Odometer', sumOdo.textContent], ['Final', sumFinal.textContent]);
    if(msrpInput.value){ rows.push(['MSRP', '$'+Number(msrpInput.value).toLocaleString()], ['MSRP √ó RV%', sumTrue.textContent]); }
    var csv = rows.map(function(r){
      return r.map(function(c){
        var s = (c==null ? '' : String(c));
        if(s.indexOf('"')!=-1 || s.indexOf(',')!=-1) s='"'+s.replace(/"/g,'""')+'"';
        return s;
      }).join(',');
    }).join('\\r\\n');
    var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href = url;
    var safeTrim = ((entry && entry.model)||'trim').replace(/[^\\w\\-]+/g,'_');
    a.download = 'residual_' + safeTrim + '_' + (dispYear||'MY').replace(/\\s+/g,'') + '.csv';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function printSummary(){ window.print(); }
  function validateJSON(){
    if(!data){ alert('Load a program first.'); return; }
    var issues = [];
    var models = data.models || {};
    var totalTrims = 0, missingCells = 0;
    function checkEntry(modelFamily, yearKey, code, entry){
      totalTrims++;
      var resids = entry.residuals || {};
      MONTHS.forEach(function(m){
        if(!(m in resids) || resids[m] == null){
          missingCells++;
          issues.push('Missing ‚Üí ['+modelFamily+'] ['+yearKey+'] ['+(entry.model||code)+'] term '+m+' mo');
        }
      });
    }
    Object.keys(models).forEach(function(fam){
      var famBranch = models[fam];
      if(!famBranch || typeof famBranch!=='object') return;
      Object.keys(famBranch).forEach(function(yearKey){
        var group = famBranch[yearKey];
        if(!group || typeof group!=='object'){ issues.push('Bad year group at '+fam+' / '+yearKey); return; }
        Object.keys(group).forEach(function(code){
          var entry = group[code];
          if(!entry || typeof entry!=='object'){ issues.push('Bad entry at '+fam+' / '+yearKey+' / '+code); return; }
          if(!('model' in entry)) issues.push('No "model" at '+fam+' / '+yearKey+' / '+code);
          if(!('residuals' in entry)) issues.push('No "residuals" at '+fam+' / '+yearKey+' / '+code);
          else checkEntry(fam, yearKey, code, entry);
        });
      });
    });
    if(!data.annual_mileage_adjustments_percent || !data.annual_mileage_adjustments_percent.miles_per_year){
      issues.push('annual_mileage_adjustments_percent.miles_per_year missing');
    }
    if(!data.mileage_at_inception_adjustments_percent){
      issues.push('mileage_at_inception_adjustments_percent missing');
    }
    var out = [];
    out.push('Program: ' + (currentProgramLabel || 'Unknown'));
    out.push('MONTHS: ' + JSON.stringify(MONTHS));
    out.push('PACPO: ' + (data.pacpo_bonus_percent || 2) + '%');
    out.push('Trims: ' + totalTrims);
    out.push('Missing cells: ' + missingCells);
    out.push('‚Äî');
    if(issues.length===0) out.push('‚úÖ No issues found!');
    else out.push('‚ö†Ô∏è Issues ('+issues.length+'):'); 
    issues.forEach(function(line){ out.push(' ‚Ä¢ ' + line); });
    validatorOutput.textContent = out.join('\\n');
    validatorCard.style.display = 'block';
  }

  // ------- Lease math -------
  function leaseCompute(){
    var rvPctText = sumFinal.textContent;
    var rvPct = (rvPctText && rvPctText.endsWith('%')) ? parseFloat(rvPctText) : NaN;
    var msrp = msrpInput.value ? Number(msrpInput.value) : NaN;
    var term = leaseTerm.value ? parseInt(leaseTerm.value, 10)
                               : (termSel && termSel.value ? parseInt(termSel.value,10) : NaN);
    var cap = leaseCapCost.value ? Number(leaseCapCost.value) : NaN;
    var mf = leaseMF.value ? Number(leaseMF.value) : NaN;
    var tax = leaseTax.value ? Number(leaseTax.value)/100 : 0;
    var capRed = leaseCapReduction.value ? Number(leaseCapReduction.value) : 0;
    var fees = leaseFees.value ? Number(leaseFees.value) : 0;

    leaseRvPct.textContent = isFinite(rvPct) ? (rvPct.toFixed(2) + '%') : '‚Äî';

    if(!isFinite(msrp) || !isFinite(rvPct) || !isFinite(term) || term <= 0){
      leaseRvAmt.textContent = '‚Äî';
      leaseAdjCap.textContent = '‚Äî';
      leasePreTax.textContent = '‚Äî';
      leaseWithTax.textContent = '‚Äî';
      mfAprHint.textContent = isFinite(mf) ? ('‚âà ' + (mf*2400).toFixed(2) + '% APR') : '';
      return;
    }

    var rvAmt = Math.round(msrp * (rvPct/100));
    leaseRvAmt.textContent = '$' + rvAmt.toLocaleString();

    var adjCap = (isFinite(cap) ? cap : 0) - (isFinite(capRed) ? capRed : 0) + (isFinite(fees) ? fees : 0);
    leaseAdjCap.textContent = isFinite(adjCap) ? ('$' + adjCap.toLocaleString()) : '‚Äî';

    if(!isFinite(adjCap) || adjCap <= 0 || !isFinite(mf) || mf <= 0){
      leasePreTax.textContent = '‚Äî';
      leaseWithTax.textContent = '‚Äî';
      mfAprHint.textContent = isFinite(mf) ? ('‚âà ' + (mf*2400).toFixed(2) + '% APR') : '';
      return;
    }

    var dep = (adjCap - rvAmt) / term;
    var fin = (adjCap + rvAmt) * mf;
    var preTax = dep + fin;
    var withTax = preTax * (1 + (isFinite(tax) ? tax : 0));

    leasePreTax.textContent = '$' + Math.round(preTax).toLocaleString();
    leaseWithTax.textContent = '$' + Math.round(withTax).toLocaleString();
    mfAprHint.textContent = isFinite(mf) ? ('‚âà ' + (mf*2400).toFixed(2) + '% APR') : '';
  }

  // ------- Sniffer -------
  function buildFinalRVForTerm(entry, term, milesPerYear, pacpoOn, inceptionAdj){
    if(!entry || !entry.residuals) return null;
    var base = entry.residuals[term];
    if(base==null) return null;
    var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    var annualAdj = (parseInt(term,10) >= 24) ? (milesMap[String(milesPerYear)] || 0) : 0;
    var pac = pacpoOn ? (data.pacpo_bonus_percent || 2) : 0;
    return base + annualAdj + pac + inceptionAdj;
  }
  function monthlyFor(term, rvPct, cap, capRed, fees, mf, tax, msrp){
    if(!isFinite(rvPct) || !isFinite(mf) || mf<=0 || !isFinite(msrp) || !isFinite(term) || term<=0) return {pre:null, with:null};
    var rvAmt = Math.round(msrp * (rvPct/100));
    var adjCap = (isFinite(cap)?cap:0) - (isFinite(capRed)?capRed:0) + (isFinite(fees)?fees:0);
    if(!isFinite(adjCap) || adjCap<=0) return {pre:null, with:null};
    var dep = (adjCap - rvAmt)/term;
    var fin = (adjCap + rvAmt) * mf;
    var pre = dep + fin;
    var withT = pre * (1 + (isFinite(tax)?tax:0));
    return {pre:pre, with:withT};
  }
  function renderSniffer(items){
    sniffGrid.innerHTML = '';
    if(!items || !items.length){ return; }
    items.slice(0,5).forEach(function(it, idx){
      var card = document.createElement('div');
      card.className = 'sniff-card' + (idx===0 ? ' sniff-best' : '');
      var top = document.createElement('div'); top.className = 'sniff-top';
      top.innerHTML = '<div class="pill-mini">Term: '+it.term+' mo</div><div class="pill-mini">LVI: '+it.lviText+'</div>';
      var rows = document.createElement('div'); rows.className = 'sniff-rows';
      rows.innerHTML = ''
        + '<div><span class="label">Final RV%</span> <span class="val">'+it.finalRv.toFixed(2)+'%</span></div>'
        + '<div><span class="label">Pre‚ÄëTax</span> <span class="val">$'+(isFinite(it.pre)?Math.round(it.pre).toLocaleString():'‚Äî')+'</span></div>'
        + '<div><span class="label">With‚ÄëTax</span> <span class="val">$'+(isFinite(it.withT)?Math.round(it.withT).toLocaleString():'‚Äî')+'</span></div>'
        + '<div><span class="label">ŒîLVI</span> <span class="val">'+it.deltaLviText+'</span></div>'
        + '<div><span class="label">Œî$/mo</span> <span class="val">'+(isFinite(it.deltaPay)?(it.deltaPay>0?'+':'')+Math.round(it.deltaPay):'‚Äî')+'</span></div>';
      var foot = document.createElement('div'); foot.className = 'sniff-foot';
      foot.innerHTML = '<span class="muted" style="font-size:.85rem">Tap to apply</span><button class="btn sniff-apply" type="button">Apply</button>';
      card.appendChild(top); card.appendChild(rows); card.appendChild(foot);
      card.addEventListener('click', function(){
        // apply selected term to both selectors and estimator
        termSel.value = String(it.term);
        if(!leaseTermDirty){ leaseTerm.value = String(it.term); }
        // Force recompute to use this term
        compute();
        // Ensure estimator term equals selection (explicit override)
        leaseTerm.value = String(it.term);
        leaseTermDirty = true; // user-intent now to keep this term
        leaseCompute();
        document.getElementById('leaseCard').scrollIntoView({behavior:'smooth',block:'start'});
      });
      sniffGrid.appendChild(card);
    });
  }
  function runSniffer(){
    var fam = familySel.value;
    var branch = branchForFamily(fam);
    var dispYear = yearSel.value;
    var yrKey = Object.keys(branch).find(function(k){ return normalizeYearKey(k).display === dispYear; });
    var code = trimSel.value;
    if(!yrKey || !code){ renderSniffer([]); return; }
    var entry = branch[yrKey][code];
    var milesPerYear = parseInt(annualMilesSel.value, 10);
    var odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''), 10) : null;

    // Inception adj resolve
    var inceptionAdj = 0;
    var inceptionKeyCandidates = [yrKey, dispYear, dispYear.replace(/\\s+/g,'')];
    for(var i=0;i<inceptionKeyCandidates.length;i++){
      var bands = (data && data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[inceptionKeyCandidates[i]]) || null;
      if(bands){ inceptionAdj = findInceptionAdj(inceptionKeyCandidates[i], odo); break; }
    }

    var msrp = msrpInput.value ? Number(msrpInput.value) : NaN;
    var cap = leaseCapCost.value ? Number(leaseCapCost.value) : NaN;
    var capRed = leaseCapReduction.value ? Number(leaseCapReduction.value) : 0;
    var fees = leaseFees.value ? Number(leaseFees.value) : 0;
    var mf = leaseMF.value ? Number(leaseMF.value) : NaN;
    var tax = leaseTax.value ? Number(leaseTax.value)/100 : 0;

    // Current scenario refs for deltas
    var curTerm = termSel.value ? parseInt(termSel.value,10) : NaN;
    var curFinal = (function(){
      if(!entry || !entry.residuals || !isFinite(curTerm)) return null;
      var base = entry.residuals[curTerm]; if(base==null) return null;
      var milesMap = (data && data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
      var annualAdj = (curTerm >= 24) ? (milesMap[String(milesPerYear)] || 0) : 0;
      var pac = pacpoToggle.checked ? (data.pacpo_bonus_percent || 2) : 0;
      return base + annualAdj + pac + inceptionAdj;
    })();
    var curLvi = computeLVI(curFinal, mf);

    // Try all available terms for this entry
    var terms = visibleMonthsFor(entry);
    var items = [];
    for(var i=0;i<terms.length;i++){
      var t = parseInt(terms[i],10);
      var rvPct = buildFinalRVForTerm(entry, terms[i], milesPerYear, pacpoToggle.checked, inceptionAdj);
      if(rvPct==null) continue;
      var pay = monthlyFor(t, rvPct, cap, capRed, fees, mf, tax, msrp);
      var lvi = computeLVI(rvPct, mf);
      if(lvi==null) continue;
      var deltaLvi = (curLvi!=null) ? (lvi - curLvi) : null;
      var deltaPay = (pay.with!=null && isFinite(pay.with) && leaseWithTax.textContent!=='‚Äî')
        ? (Math.round(pay.with) - parseInt(leaseWithTax.textContent.replace(/[^\\d]/g,''),10))
        : null;
      items.push({
        term:t, finalRv:rvPct, lvi:lvi, lviText:(lvi/1000).toFixed(1)+'k',
        pre:pay.pre, withT:pay.with,
        deltaLvi:deltaLvi, deltaLviText:(deltaLvi!=null?((deltaLvi>=0?'+':'')+(deltaLvi/1000).toFixed(1)+'k'):'‚Äî'),
        deltaPay:deltaPay
      });
    }

    // Sort: highest LVI, then lowest with-tax (if LVIs within ¬±1% absolute)
    items.sort(function(a,b){
      if(b.lvi !== a.lvi){
        // if within ¬±1% (absolute) treat as tie and compare payment
        var within = Math.abs((b.lvi - a.lvi) / ((a.lvi + b.lvi)/2 || 1)) <= 0.01;
        if(within){
          var aw = isFinite(a.withT) ? a.withT : Infinity;
          var bw = isFinite(b.withT) ? b.withT : Infinity;
          return aw - bw;
        }
        return b.lvi - a.lvi;
      } else {
        var aw2 = isFinite(a.withT) ? a.withT : Infinity;
        var bw2 = isFinite(b.withT) ? b.withT : Infinity;
        return aw2 - bw2;
      }
    });

    renderSniffer(items);
  }

  // ------- Data Load -------
  function loadProgram(file, label){
    var cacheBuster = 't=' + Date.now();
    currentProgramLabel = label || (file || '');
    return fetch(file + '?' + cacheBuster, {cache:'no-store'})
      .then(function(res){
        if(!res.ok) throw new Error('HTTP ' + res.status + ' loading ' + file);
        return res.json();
      })
      .then(function(j){
        data = j; window.__data = data;
        MONTHS = data.months || ["12","18","24","27","30","36","39","42","48","51","60"];
        PACPO = data.pacpo_bonus_percent || 2;
        sumProgram.textContent = label || file;
        initSelectors();
        // default selections
        if(familySel.value === 'Cayenne'){
          // Cayenne MY22/MY23 should appear correctly via normalizeYearKey + yearsForFamily
        }
        compute();
      });
  }

  function restoreFromParams(){
    var p = readParams();
    if(p.family){ familySel.value = p.family; }
    populate(yearSel, yearsForFamily(familySel.value));
    if(p.year && Array.from(yearSel.options).some(function(o){return o.value===p.year;})){ yearSel.value = p.year; }
    collectTrimsForYear(); populateTrims('');
    if(p.trim && Array.from(trimSel.options).some(function(o){return o.value===p.trim;})){ trimSel.value = p.trim; }
    if(p.term && Array.from(termSel.options).some(function(o){return o.value===p.term;})){ termSel.value = p.term; }
    if(p.miles){ annualMilesSel.value = p.miles; }
    if(p.odo){ odoInput.value = p.odo; }
    pacpoToggle.checked = (p.pacpo === '1');
    hideNA.checked = (p.hidena === '1');
    if(p.msrp){ msrpInput.value = p.msrp; }
  }

  // ------- Events -------
  programSel.addEventListener('change', function(){
    var label = programSel.options[programSel.selectedIndex].textContent.replace(/^Program:\\s*/,'').trim();
    loadProgram(programSel.value, label).catch(function(err){
      alert('Could not load "'+programSel.value+'". Ensure JSON exists.\\n\\n' + err.message);
    });
  });
  jumpSummaryBtn.addEventListener('click', function(){
    var el = document.getElementById('summaryBox');
    if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); el.classList.add('success-flash'); setTimeout(function(){ el.classList.remove('success-flash'); }, 600); }
  });
  familySel.addEventListener('change', function(){ populate(yearSel, yearsForFamily(familySel.value)); collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  yearSel.addEventListener('change', function(){ collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  trimSearch.addEventListener('input', function(){ populateTrims(trimSearch.value); compute(); });
  trimSel.addEventListener('change', compute);
  termSel.addEventListener('change', function(){ if(!leaseTermDirty) leaseTerm.value = termSel.value; compute(); });
  pacpoToggle.addEventListener('change', compute);
  hideNA.addEventListener('change', compute);
  annualMilesSel.addEventListener('change', compute);
  odoInput.addEventListener('input', compute);
  msrpInput.addEventListener('input', function(){ compute(); leaseCompute(); });

  copyBtn.addEventListener('click', function(){
    var parts = [
      'Program: ' + (sumProgram ? sumProgram.textContent : '‚Äî'),
      'Year: ' + sumYear.textContent,
      'Family: ' + sumFamily.textContent,
      'Trim: ' + sumTrim.textContent,
      'Term: ' + sumTerm.textContent,
      'Miles/Year: ' + sumMilesYear.textContent,
      'Odometer: ' + sumOdo.textContent,
      'Final: ' + sumFinal.textContent,
      'MSRP √ó RV%: ' + sumTrue.textContent,
      'LVI: ' + (sumLvi ? sumLvi.textContent : '‚Äî')
    ].filter(Boolean);
    var text = parts.join(' | ');
    navigator.clipboard.writeText(text).then(function(){
      var old = copyBtn.innerHTML; copyBtn.innerHTML = '‚úÖ Copied!'; copyBtn.classList.add('success-flash');
      setTimeout(function(){ copyBtn.innerHTML = old; copyBtn.classList.remove('success-flash'); }, 1500);
    });
  });

  exportCsvBtn.addEventListener('click', exportVisibleCSV);
  printBtn.addEventListener('click', printSummary);
  validateBtn.addEventListener('click', validateJSON);
  closeValBtn && closeValBtn.addEventListener('click', function(){ validatorCard.style.display='none'; });

  // Estimator inputs trigger recalcs + sniffer
  function estimatorChanged(){ leaseCompute(); runSniffer(); }
  leaseCapCost.addEventListener('input', estimatorChanged);
  leaseMF.addEventListener('input', function(){ estimatorChanged(); compute(); }); // also update LVI badge
  leaseTax.addEventListener('input', estimatorChanged);
  leaseCapReduction.addEventListener('input', estimatorChanged);
  leaseFees.addEventListener('input', estimatorChanged);
  leaseTerm.addEventListener('input', function(){ leaseTermDirty = true; estimatorChanged(); });

  // ------- Boot -------
  (function boot(){
    var label = programSel.options[programSel.selectedIndex].textContent.replace(/^Program:\\s*/,'').trim();
    loadProgram(programSel.value, label).then(function(){ restoreFromParams(); compute(); }).catch(function(err){ alert(err.message); });
  })();

})();</script>

</body>
</html>

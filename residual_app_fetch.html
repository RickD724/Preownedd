<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Residual Pro ‚Äî By Ricardo</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0e1a">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#050810; --bg-secondary:#0a0e1a; --card:rgba(255,255,255,.02); --card-hover:rgba(255,255,255,.05);
    --text:#e8edf5; --text-primary:#fff; --muted:#7c8ba1; --border:rgba(255,255,255,.08); --border-hover:rgba(59,130,246,.35);
    --accent:#3b82f6; --accent-hover:#2563eb; --accent-glow:rgba(59,130,246,.20);
    --success:#10b981; --success-glow:rgba(16,185,129,.22); --danger:#ef4444; --warning:#f59e0b;
    --purple:#8b5cf6; --purple-glow:rgba(139,92,246,.18);
    --radius:20px; --radius-sm:12px; --shadow:0 10px 40px rgba(15,23,42,.18); --shadow-lg:0 22px 60px rgba(15,23,42,.22);
    --transition:all .35s cubic-bezier(.4,0,.2,1);
  }
  [data-theme="light"]{
    --bg:#f5f7fa; --bg-secondary:#fff; --card:#fff; --card-hover:#f8fafc; --text:#1e293b; --text-primary:#0f172a; --muted:#64748b;
    --border:#e2e8f0; --border-hover:rgba(59,130,246,.35); --shadow:0 10px 40px rgba(15,23,42,.08); --shadow-lg:0 20px 60px rgba(15,23,42,.12);
    --accent-glow:rgba(59,130,246,.14); --success-glow:rgba(16,185,129,.16); --purple-glow:rgba(139,92,246,.14);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{background:var(--bg);color:var(--text);font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;min-height:100vh;overflow-x:hidden}
  .wrap{max-width:980px;margin:0 auto;padding:20px 20px 120px}

  /* Top */
  .top{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.82);backdrop-filter:blur(18px);border:1px solid var(--border);border-radius:16px;padding:12px 16px;margin-bottom:20px;box-shadow:var(--shadow)}
  [data-theme="dark"] .top{background:rgba(255,255,255,.06)}
  .brand{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:10px;background:linear-gradient(135deg,var(--accent),var(--purple));color:#fff;padding:10px 18px;border-radius:999px;font-weight:900;box-shadow:0 8px 26px var(--accent-glow)}
  .btn,.theme{border:1px solid var(--border);background:var(--card);color:var(--text);padding:9px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:var(--transition)}
  .btn:hover,.theme:hover{background:var(--card-hover);border-color:var(--border-hover);transform:translateY(-1px)}
  .select{min-width:200px}

  /* Cards / layout */
  .card{background:var(--card);border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);padding:22px;transition:var(--transition)}
  .card:hover{border-color:var(--border-hover)}
  .grid{display:grid;gap:16px}
  .g4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media(max-width:900px){.g4,.g3,.g2{grid-template-columns:1fr}}

  label{font-size:.75rem;color:var(--muted);font-weight:800;text-transform:uppercase;letter-spacing:.06em;margin:0 0 8px}
  select,input[type="number"],input[type="text"]{width:100%;background:var(--bg-secondary);color:var(--text);border:2px solid var(--border);border-radius:12px;padding:12px 14px;font-weight:600}
  select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:40px}
  .muted{color:var(--muted)}

  /* Result + table + summary */
  .result{display:flex;align-items:baseline;gap:18px;margin:18px 0 14px;flex-wrap:wrap;padding:20px;border:2px solid var(--border-hover);border-radius:16px}
  .big{font-size:3rem;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .summary{margin-top:12px;padding:18px;border:2px solid var(--border);border-radius:16px}
  .srow{display:flex;align-items:center;justify-content:space-between;background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:12px 14px}
  .sval{font-weight:900}
  .tableWrap{margin-top:10px;overflow-x:auto;border:1px solid var(--border);border-radius:16px}
  table{min-width:720px;width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:12px 14px;border-bottom:1px solid var(--border);white-space:nowrap}
  thead th{position:sticky;top:0;background:var(--card);font-size:.72rem;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;border-bottom:2px solid var(--border-hover)}
  td.ok{color:var(--success);font-weight:900}
  td.err{color:var(--danger);opacity:.6}

  /* Deal Sniffer Pro */
  .snpr .best{display:flex;flex-wrap:wrap;align-items:center;gap:16px;padding:18px;border:2px solid var(--success);border-radius:16px;background:linear-gradient(135deg,rgba(16,185,129,.10),rgba(59,130,246,.08))}
  .snpr .best .pay{font-size:2rem;font-weight:900}
  .snpr .best .meta{color:var(--muted);font-weight:700}
  .snpr .best .apply{border:1px solid var(--success);background:rgba(16,185,129,.12);padding:10px 14px;border-radius:12px;font-weight:900;cursor:pointer}
  .snpr .topgrid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px;margin-top:14px}
  @media(max-width:1000px){.snpr .topgrid{grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.snpr .topgrid{grid-template-columns:1fr}}
  .snpr .cardx{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--bg-secondary)}
  .snpr .cardx.best{border-color:var(--success);box-shadow:0 0 0 2px var(--success-glow)}
  .snpr .row{display:flex;justify-content:space-between;align-items:center}
  .snpr .pillx{font-size:.72rem;padding:3px 10px;border-radius:999px;border:1px solid var(--border-hover);font-weight:800}
  .snpr .delta.pos{color:var(--success);font-weight:900}
  .snpr .delta.neg{color:var(--danger);font-weight:900}
  .snpr .controls{display:flex;gap:12px;align-items:center;margin-top:10px;flex-wrap:wrap}
  .snpr .toggle{display:flex;gap:8px;align-items:center;border:1px solid var(--border);background:var(--bg-secondary);padding:8px 10px;border-radius:10px;font-weight:700}
  .snpr .small{font-size:.85rem;color:var(--muted)}
  .snpr .adv{margin-top:12px}
  .snpr details{border:1px dashed var(--border);border-radius:12px;padding:10px}
  .snpr summary{cursor:pointer;font-weight:900}

  .error-banner,.info-banner{display:none;margin:8px 0;padding:10px 12px;border-radius:12px;font-weight:800}
  .error-banner{border:1px solid rgba(239,68,68,.35);background:rgba(239,68,68,.08)}
  .info-banner{border:1px solid rgba(59,130,246,.35);background:rgba(59,130,246,.08)}
</style>
</head>
<body>
<div class="wrap">
  <!-- Top bar -->
  <div class="top">
    <div class="brand">
      <div class="pill">‚ö° Residual Pro ‚Äî By Ricardo</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <select id="programSel" class="select">
          <option value="porsche_residuals_all.json" selected>Program: PB 25-10R (Default)</option>
          <option value="porsche_residuals_25-09R.json">Program: PB 25-09R (Oct)</option>
          <option value="__current__">Program: Current (from ?data)</option>
        </select>
        <button id="jumpSummaryBtn" class="btn" type="button">üìä Summary</button>
        <button id="validateBtn" class="btn" type="button">‚úì Validate</button>
        <button id="exportCsvBtn" class="btn" type="button">üì• Export</button>
        <button id="printBtn" class="btn" type="button">üñ®Ô∏è Print</button>
        <button id="themeBtn" class="theme" type="button">üåô Dark</button>
      </div>
    </div>
    <div id="errorBanner" class="error-banner"></div>
    <div id="infoBanner" class="info-banner"></div>
  </div>

  <!-- Controls -->
  <div class="card" id="controls">
    <div class="grid g4">
      <div><label>üöó Model Family</label><select id="familySel"></select></div>
      <div><label>üìÖ Model Year</label><select id="yearSel"></select></div>
      <div>
        <label>üéØ Trim</label>
        <select id="trimSel"></select>
        <div class="muted" id="trimCount" style="font-size:.85rem;margin-top:6px"></div>
        <div class="muted" id="trimWarn" style="display:none;color:var(--danger)">‚ö†Ô∏è No trims found</div>
      </div>
      <div>
        <label>üîç Search Trim</label>
        <input id="trimSearch" type="text" placeholder="Type to filter..." />
      </div>
    </div>

    <div class="grid g3" style="margin-top:12px">
      <div><label>‚è±Ô∏è Term (months)</label><select id="termSel"></select></div>
      <div><label>üìä Miles per Year</label><select id="annualMilesSel"></select></div>
      <div style="display:flex;gap:12px;align-items:center;margin-top:26px;flex-wrap:wrap">
        <label style="display:flex;gap:8px;align-items:center"><input id="pacpoToggle" type="checkbox" /> <span>+2% PACPO</span></label>
        <label style="display:flex;gap:8px;align-items:center"><input id="hideNA" type="checkbox" /> <span>Hide N/A</span></label>
        <div class="pill" id="codeBadge" style="font-size:.85rem;padding:6px 12px">Code: ‚Äî</div>
      </div>
    </div>

    <div class="grid g3" style="margin-top:12px">
      <div><label>üõ£Ô∏è Miles at Inception</label><input id="odoInput" type="number" min="0" step="1" placeholder="e.g., 3,450" /></div>
      <div><label>üí∞ MSRP ($)</label><input id="msrpInput" type="number" min="0" step="100" placeholder="e.g., 142,000" /></div>
      <div><label>üîó Shareable Link</label><input id="shareLink" type="text" readonly style="font-size:.85rem" /></div>
    </div>
  </div>

  <!-- Result + Table + Summary -->
  <div class="card" style="margin-top:16px">
    <div class="result">
      <div class="big" id="finalOut">‚Äî</div>
      <div class="muted" id="detailOut">Select options to calculate</div>
      <div class="small" id="trueOut" style="font-weight:800"></div>
      <div class="small muted" id="lviBadge" style="font-weight:800"></div>
    </div>

    <div class="tableWrap">
      <table id="residualTable">
        <thead><tr id="theadRow"></tr></thead>
        <tbody><tr id="tvalRow"></tr></tbody>
      </table>
    </div>

    <div class="summary" id="summaryBox">
      <div class="srow" style="border:2px solid var(--accent);margin-bottom:10px">
        <span style="font-weight:900">Final Residual</span>
        <span class="sval" id="sumFinal" style="color:var(--accent);font-size:1.4rem">‚Äî</span>
      </div>
      <div class="grid g2">
        <div class="srow"><span>Program</span><span class="sval" id="sumProgram">‚Äî</span></div>
        <div class="srow"><span>Model Year</span><span class="sval" id="sumYear">‚Äî</span></div>
        <div class="srow"><span>Family</span><span class="sval" id="sumFamily">‚Äî</span></div>
        <div class="srow"><span>Trim</span><span class="sval" id="sumTrim">‚Äî</span></div>
        <div class="srow"><span>Term</span><span class="sval" id="sumTerm">‚Äî</span></div>
        <div class="srow"><span>Miles/Year</span><span class="sval" id="sumMilesYear">‚Äî</span></div>
        <div class="srow"><span>Odometer</span><span class="sval" id="sumOdo">‚Äî</span></div>
        <div class="srow"><span>MSRP √ó RV%</span><span class="sval" id="sumTrue">‚Äî</span></div>
        <div class="srow"><span>Value Index</span><span class="sval" id="sumLvi">‚Äî</span></div>
      </div>
      <div class="muted" style="margin-top:8px;font-style:italic">Higher Value Index = Better Deal</div>
    </div>
  </div>

  <!-- Lease Estimator -->
  <div class="card" id="leaseCard" style="margin-top:16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong style="font-size:1.1rem">üí≥ Lease Estimator</strong>
      <span class="muted" style="font-size:.95rem">Uses current RV% & term</span>
    </div>
    <div class="grid g3">
      <div><label>üíµ Cap Cost ($)</label><input id="leaseCapCost" type="number" min="0" step="100" placeholder="e.g., 165000" /></div>
      <div><label>üìà Money Factor</label><input id="leaseMF" type="number" min="0" step="0.00001" placeholder="0.00400" /><div class="muted" id="mfAprHint" style="font-size:.85rem;margin-top:6px"></div></div>
      <div><label>üßæ Tax Rate (%)</label><input id="leaseTax" type="number" min="0" step="0.01" placeholder="9.75" /></div>
    </div>
    <div class="grid g3" style="margin-top:10px">
      <div><label>üí∏ Cap Reduction ($)</label><input id="leaseCapReduction" type="number" min="0" step="100" placeholder="7500" /></div>
      <div><label>üìù Rolled Fees ($)</label><input id="leaseFees" type="number" min="0" step="25" placeholder="1095" /></div>
      <div><label>‚è∞ Term (mo)</label><input id="leaseTerm" type="number" min="12" step="1" placeholder="auto" /></div>
    </div>
    <div class="grid g3" style="margin-top:10px">
      <div class="srow"><span>Residual %</span><span class="sval" id="leaseRvPct">‚Äî</span></div>
      <div class="srow"><span>Residual $</span><span class="sval" id="leaseRvAmt">‚Äî</span></div>
      <div class="srow"><span>Adj Cap Cost</span><span class="sval" id="leaseAdjCap">‚Äî</span></div>
    </div>
    <div class="grid g2" style="margin-top:10px">
      <div class="srow" style="border:2px solid var(--success)"><span style="color:var(--success)">Monthly (Pre-Tax)</span><span class="sval" id="leasePreTax" style="color:var(--success)">‚Äî</span></div>
      <div class="srow" style="border:2px solid var(--purple)"><span style="color:var(--purple)">Monthly (With Tax)</span><span class="sval" id="leaseWithTax" style="color:var(--purple)">‚Äî</span></div>
    </div>
  </div>

  <!-- Deal Sniffer Pro -->
  <div class="card snpr" id="snifferProCard" style="margin-top:16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong style="font-size:1.1rem">üîé Deal Sniffer Pro</strong>
      <span class="small">Scans terms (and optionally miles/yr) for the selected Year & Trim</span>
    </div>
    <div class="controls">
      <label class="toggle"><input id="sniffAllowPacpoOff" type="checkbox" checked/> Allow PACPO Off in search</label>
      <label class="toggle"><input id="sniffVaryMiles" type="checkbox"/> Allow varying miles/yr</label>
      <label class="toggle"><input id="sniffShowAdvanced" type="checkbox" checked/> Show Top-5 + Advanced Compare</label>
    </div>

    <div id="snprBest" class="best" style="display:none">
      <div>
        <div class="small">Best Pick</div>
        <div class="pay" id="snprBestPay">$‚Äî</div>
        <div class="meta" id="snprBestMeta">‚Äî</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
        <button id="snprApplyBtn" class="apply" type="button">‚úÖ Apply Best</button>
        <div class="small" id="snprDelta">Œî vs current: ‚Äî</div>
      </div>
    </div>

    <div class="topgrid" id="snprTopGrid" style="display:none"></div>

    <div class="adv" id="snprAdvanced" style="display:none">
      <details open>
        <summary>Advanced Compare</summary>
        <div class="tableWrap" style="margin-top:10px">
          <table>
            <thead>
              <tr><th>Term</th><th>Miles/yr</th><th>PACPO</th><th>RV%</th><th>LVI</th><th>$ Pre-Tax</th><th>$ With Tax</th><th>$/mi</th></tr>
            </thead>
            <tbody id="snprTbody"></tbody>
          </table>
        </div>
      </details>
    </div>
    <div id="snprHint" class="small" style="margin-top:8px">Enter Cap Cost + MSRP + MF to sniff deals.</div>
  </div>

  <div class="footer" style="margin-top:20px"><div class="muted" style="text-align:center">¬© Ricardo ‚Äî Internal tool</div></div>
</div>

<script>
(function(){
  // Helpers
  const $=id=>document.getElementById(id);
  const show=(el,vis)=>{ el.style.display = vis ? '' : 'none'; };
  const banner=(el,msg)=>{ el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',7000); };

  // Theme: light default
  const themeBtn=$('themeBtn');
  document.documentElement.setAttribute('data-theme','light');
  themeBtn.onclick=()=>{ const cur=document.documentElement.getAttribute('data-theme'); const next=cur==='light'?'dark':'light'; document.documentElement.setAttribute('data-theme',next); themeBtn.innerHTML=next==='light'?'üåô Dark':'‚òÄÔ∏è Light'; };

  // Refs
  const programSel=$('programSel'), validateBtn=$('validateBtn'), exportCsvBtn=$('exportCsvBtn'), printBtn=$('printBtn'), jumpSummaryBtn=$('jumpSummaryBtn');
  const familySel=$('familySel'), yearSel=$('yearSel'), trimSel=$('trimSel'), trimSearch=$('trimSearch'), trimCount=$('trimCount'), trimWarn=$('trimWarn');
  const termSel=$('termSel'), annualMilesSel=$('annualMilesSel'), pacpoToggle=$('pacpoToggle'), hideNA=$('hideNA'), codeBadge=$('codeBadge');
  const odoInput=$('odoInput'), msrpInput=$('msrpInput'), shareLink=$('shareLink');
  const finalOut=$('finalOut'), detailOut=$('detailOut'), trueOut=$('trueOut'), lviBadge=$('lviBadge');
  const theadRow=$('theadRow'), tvalRow=$('tvalRow');
  const sumProgram=$('sumProgram'), sumYear=$('sumYear'), sumFamily=$('sumFamily'), sumTrim=$('sumTrim'), sumTerm=$('sumTerm'), sumMilesYear=$('sumMilesYear'), sumOdo=$('sumOdo'), sumTrue=$('sumTrue'), sumFinal=$('sumFinal'), sumLvi=$('sumLvi');

  const leaseCapCost=$('leaseCapCost'), leaseMF=$('leaseMF'), leaseTax=$('leaseTax'), leaseCapReduction=$('leaseCapReduction'), leaseFees=$('leaseFees'), leaseTerm=$('leaseTerm');
  const leaseRvPct=$('leaseRvPct'), leaseRvAmt=$('leaseRvAmt'), leaseAdjCap=$('leaseAdjCap'), leasePreTax=$('leasePreTax'), leaseWithTax=$('leaseWithTax'), mfAprHint=$('mfAprHint');

  const snprCard=$('snifferProCard'), snprBest=$('snprBest'), snprBestPay=$('snprBestPay'), snprBestMeta=$('snprBestMeta'), snprApplyBtn=$('snprApplyBtn'), snprDelta=$('snprDelta'), snprTopGrid=$('snprTopGrid'), snprAdvanced=$('snprAdvanced'), snprTbody=$('snprTbody');
  const sniffAllowPacpoOff=$('sniffAllowPacpoOff'), sniffVaryMiles=$('sniffVaryMiles'), sniffShowAdvanced=$('sniffShowAdvanced');

  const errorBanner=$('errorBanner'), infoBanner=$('infoBanner');

  let data=null, MONTHS=[], PACPO=2, fullTrimList=[];
  let currentProgramLabel='PB 25-10R (Default)';
  let initialProgram=(new URLSearchParams(location.search)).get('data');

  // JSON loader: prefer default; if ?data provided and fails, fallback
  async function loadProgram(selectVal,label){
    currentProgramLabel=label||currentProgramLabel;
    const source = (selectVal==='__current__' && initialProgram) ? initialProgram : selectVal;
    try{
      const url = new URL(source, location.href).href;
      const res = await fetch(url,{cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const j = await res.json();
      afterJSONLoaded(j);
    }catch(e){
      banner(errorBanner,`Failed to load program (using fallback): ${String(source).split('/').slice(-1)[0]}`);
      // Try default file
      try{
        const res2=await fetch('porsche_residuals_all.json',{cache:'no-store'});
        const j2=await res2.json();
        currentProgramLabel = 'PB 25-10R (Default)';
        programSel.value='porsche_residuals_all.json';
        afterJSONLoaded(j2);
      }catch(e2){
        // tiny built-in sample to keep UI alive
        afterJSONLoaded({
          months:["24","36","39","48"],
          pacpo_bonus_percent:2,
          annual_mileage_adjustments_percent:{miles_per_year:{"7500":4,"10000":3,"12000":2,"15000":0}},
          mileage_at_inception_adjustments_percent:{ "MY25":[{miles_range:"0‚Äì499",adj:0},{miles_range:"500‚Äì1499",adj:-1}] },
          models:{ "911":{ "MY25":{ "992C2":{ model:"Carrera", residuals:{"24":72,"36":63,"39":61,"48":55} } } } }
        });
      }
    }
  }

  function afterJSONLoaded(j){
    data=j; window.__data=j;
    MONTHS=data.months||["12","18","24","27","30","36","39","42","48","51","60"];
    PACPO=data.pacpo_bonus_percent||2;
    sumProgram.textContent=currentProgramLabel;
    initSelectors();
    applyLeaseDefaultsIfEmpty();
    compute();
  }

  function normalizeYearKey(k){
    const s=String(k).trim();
    const mPlain=s.match(/^(20\d{2})$/); if(mPlain) return {display:'MY'+mPlain[1].slice(-2), key:k};
    const mMY=s.toUpperCase().replace(/\s+/g,'').match(/^MY(\d{2})$/); if(mMY) return {display:'MY'+mMY[1], key:k};
    return {display:s, key:k};
  }
  function getCaseInsensitive(obj,name){
    if(!obj||typeof obj!=='object') return undefined;
    const t=String(name).replace(/\s+/g,'').toLowerCase();
    return Object.keys(obj).find(k=>k.replace(/\s+/g,'').toLowerCase()===t) ? obj[Object.keys(obj).find(k=>k.replace(/\s+/g,'').toLowerCase()===t)] : undefined;
  }
  function getVirtualFamilies(){
    const out=new Set(); const models=data.models||{};
    Object.keys(models).forEach(f=>{
      if(f==='718'){ if(getCaseInsensitive(models['718'],'Cayman')) out.add('718 Cayman'); if(getCaseInsensitive(models['718'],'Boxster')) out.add('718 Boxster'); }
      else out.add(f);
    });
    if(models['Cayman']) out.add('718 Cayman');
    if(models['Boxster']) out.add('718 Boxster');
    const order=['911','718 Cayman','718 Boxster','Taycan','Macan','Cayenne','Panamera'];
    return Array.from(out).sort((a,b)=>order.indexOf(a)-order.indexOf(b));
  }
  function branchForFamily(f){
    const models=data.models||{};
    if(f==='718 Cayman') return getCaseInsensitive(models['718']||{},'Cayman')||models['Cayman']||{};
    if(f==='718 Boxster') return getCaseInsensitive(models['718']||{},'Boxster')||models['Boxster']||{};
    return models[f]||{};
  }
  function yearsForFamily(fam){
    const b=branchForFamily(fam); const out=new Set();
    Object.keys(b).forEach(k=>out.add(normalizeYearKey(k).display));
    return Array.from(out).sort((a,b)=>{const ay=parseInt(a.replace(/\D/g,''),10), by=parseInt(b.replace(/\D/g,''),10); if(isNaN(ay)||isNaN(by)) return b.localeCompare(a); return by-ay;});
  }

  function populate(sel,arr){ sel.innerHTML=''; arr.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }); }
  function populateAnnualMiles(){
    annualMilesSel.innerHTML='';
    const milesMap=(data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {"2500":6,"5000":5,"7500":4,"10000":3,"12000":2,"15000":0};
    Object.keys(milesMap).map(k=>parseInt(k,10)).sort((a,b)=>a-b).forEach(n=>{
      const o=document.createElement('option'); o.value=String(n); o.textContent=n.toLocaleString()+' mi/yr'; annualMilesSel.appendChild(o);
    });
    annualMilesSel.value="15000";
  }

  function cleanTrimLabel(label){
    // Remove leading code token like "20239YAAA1 " and keep the human model name
    return String(label||'').replace(/^\s*20\d{2}[A-Z0-9]+\s+/,'').trim();
  }

  function collectTrimsForYear(){
    fullTrimList=[];
    const branch=branchForFamily(familySel.value);
    const dispYear=yearSel.value;
    const yearKey=Object.keys(branch).find(k=>normalizeYearKey(k).display===dispYear);
    const rows=(yearKey && branch[yearKey])||{};
    Object.entries(rows).forEach(([code,entry])=>{
      fullTrimList.push({code, model: cleanTrimLabel(entry.model||code)});
    });
  }
  function populateTrims(filterTerm){
    trimSel.innerHTML='';
    const term=(filterTerm||'').trim().toLowerCase();
    const filtered=fullTrimList.filter(t=>(t.model+' '+t.code).toLowerCase().includes(term));
    filtered.forEach(item=>{ const opt=document.createElement('option'); opt.value=item.code; opt.textContent=item.model; opt.dataset.code=item.code; trimSel.appendChild(opt); });
    trimCount.textContent = filtered.length ? (filtered.length+' trim(s) available') : 'No matches';
    trimWarn.style.display = filtered.length ? 'none' : 'block';
  }

  function initSelectors(){
    populate(familySel, getVirtualFamilies());
    populate(yearSel, yearsForFamily(familySel.value));
    termSel.innerHTML=''; MONTHS.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m+' months'; termSel.appendChild(o); });
    populateAnnualMiles();
    collectTrimsForYear(); populateTrims('');
  }

  function parseRange(str){
    if(!str) return null;
    const s=str.replace(/,/g,'').replace(/\s/g,''); const parts=s.split(/‚Äì|-/); if(parts.length!==2) return null;
    const a=parseInt(parts[0],10), b=parseInt(parts[1],10); if(isNaN(a)||isNaN(b)) return null; return [a,b];
  }
  function findInceptionAdj(myKey,odo){
    const bands=data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[myKey];
    if(!bands||odo==null) return 0;
    for(let i=0;i<bands.length;i++){ const rng=parseRange(bands[i].miles_range); if(!rng) continue; if(odo>=rng[0] && odo<=rng[1]) return bands[i].adj||0; }
    return 0;
  }
  function visibleMonthsFor(entry){
    if(!hideNA.checked) return MONTHS.slice();
    const r=[]; for(let i=0;i<MONTHS.length;i++){ if(entry && entry.residuals && entry.residuals[MONTHS[i]]!=null) r.push(MONTHS[i]); }
    return r;
  }
  function buildHeader(months){ theadRow.innerHTML=''; const th1=document.createElement('th'); th1.textContent='Trim / Term'; theadRow.appendChild(th1); months.forEach(m=>{ const th=document.createElement('th'); th.textContent=m+' mo'; theadRow.appendChild(th); }); }

  function computeLVI(rvPct,mf){ if(!isFinite(rvPct)||!isFinite(mf)||mf<=0) return null; return rvPct/mf; }

  // Core compute (summary + table + lease)
  function compute(){
    const fam=familySel.value;
    const branch=branchForFamily(fam);
    const dispYear=yearSel.value;
    const yrKey=Object.keys(branch).find(k=>normalizeYearKey(k).display===dispYear);
    const code=trimSel.value;
    const term=termSel.value;
    const milesPerYear=parseInt(annualMilesSel.value,10);
    const odo=odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''),10) : null;

    if(!yrKey || !code){
      finalOut.textContent='‚Äî'; detailOut.textContent='Select family/year/trim'; trueOut.textContent=''; if(lviBadge) lviBadge.textContent=''; if(sumLvi) sumLvi.textContent='‚Äî'; updateShareURL(); runSniffer(); return;
    }

    const entry=branch[yrKey][code];
    const base=term ? ((entry && entry.residuals && entry.residuals[term])||null) : null;
    const pacpoAdj = pacpoToggle.checked ? (data.pacpo_bonus_percent||2) : 0;

    const milesMap=(data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    let annualAdj=0; if(base!==null && parseInt(term||"0",10)>=24){ annualAdj = milesMap[String(milesPerYear)] || 0; }

    const inceptionKeyCandidates=[yrKey, dispYear, dispYear.replace(/\s+/g,'')];
    let inceptionAdj=0;
    for(let i=0;i<inceptionKeyCandidates.length;i++){ const bands=data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[inceptionKeyCandidates[i]]; if(bands){ inceptionAdj=findInceptionAdj(inceptionKeyCandidates[i], odo); break; } }

    const monthsShown=visibleMonthsFor(entry); buildHeader(monthsShown);

    const final = (base===null || term==null) ? null : (base + pacpoAdj + annualAdj + inceptionAdj);
    finalOut.textContent = final===null ? '‚Äî' : final + '%';
    detailOut.textContent = final===null ? 'Select a term' : 'Final with all adjustments';
    codeBadge.textContent='Code: '+(code||'‚Äî');

    tvalRow.innerHTML=''; const lead=document.createElement('td'); lead.textContent=(entry && cleanTrimLabel(entry.model)) || '‚Äî'; tvalRow.appendChild(lead);
    monthsShown.forEach(m=>{
      const td=document.createElement('td'); const v=entry && entry.residuals && entry.residuals[m]; let shown='‚Äî';
      if(v!=null){
        const mN=parseInt(m,10); const aAdj=(mN>=24) ? (milesMap[String(milesPerYear)] || 0) : 0;
        const total=v + pacpoAdj + aAdj + inceptionAdj; shown=total+'%'; td.classList.add('ok');
      } else td.classList.add('err');
      td.textContent=shown; tvalRow.appendChild(td);
    });

    sumProgram.textContent=currentProgramLabel; sumYear.textContent=dispYear||'‚Äî'; sumFamily.textContent=fam||'‚Äî'; sumTrim.textContent=(entry && cleanTrimLabel(entry.model))||'‚Äî';
    sumTerm.textContent=term ? (term+' mo') : '‚Äî'; sumMilesYear.textContent=Number.isFinite(milesPerYear) ? milesPerYear.toLocaleString()+' mi/yr':'‚Äî'; sumOdo.textContent=(odo!=null&&!isNaN(odo)) ? odo.toLocaleString()+' mi':'‚Äî';

    const msrp = msrpInput.value ? Number(msrpInput.value) : null;
    const trueResidual = (final!=null && msrp!=null && !isNaN(msrp)) ? Math.round(msrp*(final/100)) : null;
    sumTrue.textContent = (trueResidual!=null) ? ('$'+trueResidual.toLocaleString()) : '‚Äî';
    trueOut.innerHTML = (trueResidual!=null) ? ('<span style="font-weight:800">MSRP √ó RV% = </span><span style="font-weight:900">$'+trueResidual.toLocaleString()+'</span>') : '';

    sumFinal.textContent = final===null ? '‚Äî' : final + '%';

    // LVI badge uses current MF if entered
    const mfVal = leaseMF.value ? Number(leaseMF.value) : NaN;
    const lvi = computeLVI(final, mfVal);
    if(lvi!=null){ const t=(lvi/1000).toFixed(1)+'k'; if(lviBadge) lviBadge.textContent='LVI: '+t; if(sumLvi) sumLvi.textContent=t; } else { if(lviBadge) lviBadge.textContent=''; if(sumLvi) sumLvi.textContent='‚Äî'; }

    // Sync lease term field from picker
    if(leaseTerm && termSel && termSel.value) leaseTerm.value = termSel.value;

    updateShareURL();
    leaseCompute();      // then sniffer (sniffer uses lease inputs)
    runSniffer();
  }

  function updateShareURL(){
    const p=new URLSearchParams();
    const program=(programSel.value==='__current__' && initialProgram) ? initialProgram : programSel.value;
    p.set('data', program);
    if(familySel.value) p.set('family', familySel.value);
    if(yearSel.value) p.set('year', yearSel.value);
    if(trimSel.value) p.set('trim', trimSel.value);
    if(termSel.value) p.set('term', termSel.value);
    if(annualMilesSel.value) p.set('miles', annualMilesSel.value);
    if(odoInput.value) p.set('odo', odoInput.value);
    if(pacpoToggle.checked) p.set('pacpo','1');
    if(hideNA.checked) p.set('hidena','1');
    if(msrpInput.value) p.set('msrp', msrpInput.value);
    const url=location.pathname+'?'+p.toString();
    shareLink.value=location.origin+url;
    history.replaceState(null,'',url);
  }

  function exportVisibleCSV(){
    const fam=familySel.value; const branch=branchForFamily(fam); const dispYear=yearSel.value;
    const yrKey=Object.keys(branch).find(k=>normalizeYearKey(k).display===dispYear);
    if(!yrKey||!trimSel.value){ alert('Select family/year/trim first.'); return; }
    const entry=branch[yrKey][trimSel.value]; const monthsShown=visibleMonthsFor(entry);
    const rows=[]; rows.push(['Trim/Term'].concat(monthsShown.map(m=>m+' mo')));
    const line=[cleanTrimLabel(entry.model)||'‚Äî'];
    const milesPerYear=parseInt(annualMilesSel.value,10);
    const pacpoAdj=pacpoToggle.checked ? (data.pacpo_bonus_percent||2) : 0;
    const milesMap=(data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year)||{};
    const odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''),10) : null;

    let inceptionAdj=0; [''+yrKey, dispYear, dispYear.replace(/\s+/g,'')].some(k=>{ const b=data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[k]; if(b){ inceptionAdj=findInceptionAdj(k,odo); return true; } return false; });

    monthsShown.forEach(m=>{
      const v=entry && entry.residuals && entry.residuals[m];
      if(v==null){ line.push(''); return; }
      const aAdj=(parseInt(m,10)>=24) ? (milesMap[String(milesPerYear)]||0) : 0;
      const total=v+pacpoAdj+aAdj+inceptionAdj;
      line.push(total+'%');
    });
    rows.push(line);
    rows.push([]); rows.push(['Program',currentProgramLabel],['Year',dispYear],['Family',fam],['Trim',cleanTrimLabel(entry.model)||'‚Äî'],['Term',termSel.value?termSel.value+' mo':'‚Äî'],['Miles/Year', sumMilesYear.textContent],['Odometer', sumOdo.textContent],['Final', sumFinal.textContent], ['MSRP √ó RV%', sumTrue.textContent]);

    const csv = rows.map(r=>r.map(c=>{ let s=(c==null?'':String(c)); if(s.includes('"')||s.includes(',')) s='"'+s.replace(/"/g,'""')+'"'; return s; }).join(',')).join('\r\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='residual_'+(cleanTrimLabel(branch[yrKey][trimSel.value].model)||'trim').replace(/[^\w\-]+/g,'_')+'_'+(dispYear||'MY').replace(/\s+/g,'')+'.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function printSummary(){ window.print(); }

  function validateJSON(){
    if(!data){ alert('Load a program first.'); return; }
    let issues=[]; const models=data.models||{}; let totalTrims=0, missingCells=0;
    function checkEntry(fam,yearKey,code,entry){
      totalTrims++; const resids=entry.residuals||{}; MONTHS.forEach(m=>{ if(!(m in resids) || resids[m]==null){ missingCells++; issues.push(`Missing ‚Üí [${fam}] [${yearKey}] [${entry.model||code}] term ${m} mo`); } });
    }
    Object.keys(models).forEach(fam=>{ const famBranch=models[fam]; if(!famBranch||typeof famBranch!=='object') return;
      Object.keys(famBranch).forEach(yearKey=>{ const group=famBranch[yearKey]; if(!group||typeof group!=='object'){ issues.push('Bad year group at '+fam+' / '+yearKey); return; }
        Object.keys(group).forEach(code=>{ const entry=group[code]; if(!entry||typeof entry!=='object'){ issues.push('Bad entry at '+fam+' / '+yearKey+' / '+code); return; }
          if(!('model' in entry)) issues.push('No "model" at '+fam+' / '+yearKey+' / '+code);
          if(!('residuals' in entry)) issues.push('No "residuals" at '+fam+' / '+yearKey+' / '+code);
          else checkEntry(fam,yearKey,code,entry);
        });
      });
    });
    if(!data.annual_mileage_adjustments_percent || !data.annual_mileage_adjustments_percent.miles_per_year) issues.push('annual_mileage_adjustments_percent.miles_per_year missing');
    if(!data.mileage_at_inception_adjustments_percent) issues.push('mileage_at_inception_adjustments_percent missing');

    const out=[]; out.push('Program: '+(currentProgramLabel||'Unknown')); out.push('MONTHS: '+JSON.stringify(MONTHS)); out.push('PACPO: '+(data.pacpo_bonus_percent||2)+'%'); out.push('Trims: '+totalTrims); out.push('Missing cells: '+missingCells); out.push('‚Äî');
    if(issues.length===0) out.push('‚úÖ No issues found!'); else { out.push('‚ö†Ô∏è Issues ('+issues.length+'):'); issues.forEach(l=>out.push(' ‚Ä¢ '+l)); }
    const el=document.createElement('pre'); el.style.whiteSpace='pre-wrap'; el.style.font='12px ui-monospace, SFMono-Regular, Menlo, monospace'; el.textContent=out.join('\n'); const w=window.open('','_blank'); w.document.write('<pre style="white-space:pre-wrap;font:12px ui-monospace, SFMono-Regular, Menlo, monospace">'+el.textContent+'</pre>');
  }

  function leaseCompute(){
    const rvPctText=sumFinal.textContent; const rvPct=(rvPctText&&rvPctText.endsWith('%'))?parseFloat(rvPctText):NaN;
    const msrp=msrpInput.value ? Number(msrpInput.value) : NaN;
    const term=leaseTerm.value ? parseInt(leaseTerm.value,10) : (termSel && termSel.value ? parseInt(termSel.value,10) : NaN);
    const cap=leaseCapCost.value ? Number(leaseCapCost.value) : NaN;
    const mf=leaseMF.value ? Number(leaseMF.value) : NaN;
    const tax=leaseTax.value ? Number(leaseTax.value)/100 : 0;
    const capRed=leaseCapReduction.value ? Number(leaseCapReduction.value) : 0;
    const fees=leaseFees.value ? Number(leaseFees.value) : 0;

    leaseRvPct.textContent=isFinite(rvPct)?(rvPct.toFixed(2)+'%'):'‚Äî';

    if(!isFinite(msrp)||!isFinite(rvPct)||!isFinite(term)||term<=0){ leaseRvAmt.textContent='‚Äî'; leaseAdjCap.textContent='‚Äî'; leasePreTax.textContent='‚Äî'; leaseWithTax.textContent='‚Äî'; mfAprHint.textContent=isFinite(mf)?('‚âà '+(mf*2400).toFixed(2)+'% APR'):''; return; }

    const rvAmt=Math.round(msrp*(rvPct/100)); leaseRvAmt.textContent='$'+rvAmt.toLocaleString();
    const adjCap=(isFinite(cap)?cap:0) - (isFinite(capRed)?capRed:0) + (isFinite(fees)?fees:0); leaseAdjCap.textContent=isFinite(adjCap)?('$'+adjCap.toLocaleString()):'‚Äî';
    if(!isFinite(adjCap)||adjCap<=0||!isFinite(mf)||mf<=0){ leasePreTax.textContent='‚Äî'; leaseWithTax.textContent='‚Äî'; mfAprHint.textContent=isFinite(mf)?('‚âà '+(mf*2400).toFixed(2)+'% APR'):''; return; }
    const dep=(adjCap - rvAmt)/term; const fin=(adjCap + rvAmt)*mf; const preTax=dep+fin; const withTax=preTax*(1+(isFinite(tax)?tax:0));
    leasePreTax.textContent='$'+Math.round(preTax).toLocaleString(); leaseWithTax.textContent='$'+Math.round(withTax).toLocaleString(); mfAprHint.textContent=isFinite(mf)?('‚âà '+(mf*2400).toFixed(2)+'% APR'):'';
  }

  function applyLeaseDefaultsIfEmpty(){
    if(!leaseMF.value) leaseMF.value='0.00400';
    if(!leaseTax.value) leaseTax.value='9.75';
    if(!leaseCapReduction.value) leaseCapReduction.value='7500';
    if(!leaseFees.value) leaseFees.value='1095';
    if(termSel && termSel.value) leaseTerm.value=termSel.value;
    leaseCompute();
  }

  // ----- Deal Sniffer Pro -----
  function allMileageBands(){
    const map=(data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    return Object.keys(map).map(k=>parseInt(k,10)).sort((a,b)=>a-b);
  }

  function computeRV(entry, term, milesPerYear, pacpoOn, dispYear, yrKey){
    if(!entry || !entry.residuals || entry.residuals[term]==null) return null;
    const base=entry.residuals[term];
    const milesMap=(data.annual_mileage_adjustments_percent && data.annual_mileage_adjustments_percent.miles_per_year) || {};
    const aAdj=(parseInt(term,10)>=24)?(milesMap[String(milesPerYear)]||0):0;
    const pac= pacpoOn ? (data.pacpo_bonus_percent||2) : 0;

    // inception adj (if bands exist)
    const odo = odoInput.value ? parseInt(String(odoInput.value).replace(/,/g,''),10) : null;
    let inc=0; [yrKey,dispYear,dispYear.replace(/\s+/g,'')].some(k=>{ const b=data.mileage_at_inception_adjustments_percent && data.mileage_at_inception_adjustments_percent[k]; if(b){ inc=findInceptionAdj(k,odo); return true; } return false; });
    return base + pac + aAdj + inc;
  }

  function paymentFor(rvPct){
    const msrp=Number(msrpInput.value||NaN); const term=Number(leaseTerm.value||termSel.value||NaN);
    const cap=Number(leaseCapCost.value||NaN); const mf=Number(leaseMF.value||NaN); const tax=(Number(leaseTax.value||0)/100)||0;
    const capRed=Number(leaseCapReduction.value||0); const fees=Number(leaseFees.value||0);
    if(!isFinite(msrp)||!isFinite(rvPct)||!isFinite(term)||term<=0||!isFinite(cap)||!isFinite(mf)||mf<=0) return {pre:null,withTax:null,rvAmt:null};
    const rvAmt=Math.round(msrp*(rvPct/100)); const adjCap=(cap - (isFinite(capRed)?capRed:0) + (isFinite(fees)?fees:0)); if(adjCap<=0) return {pre:null,withTax:null,rvAmt};
    const dep=(adjCap - rvAmt)/term; const fin=(adjCap + rvAmt)*mf; const pre=dep+fin; const wt=pre*(1+tax);
    return {pre,withTax:wt,rvAmt};
  }

  function runSniffer(){
    // Preconditions: need Year/Trim and enough lease inputs
    const fam=familySel.value; const branch=branchForFamily(fam); const dispYear=yearSel.value; const yrKey=Object.keys(branch).find(k=>normalizeYearKey(k).display===dispYear); const code=trimSel.value;
    const entry = (yrKey && code) ? branch[yrKey][code] : null;
    const cap=Number(leaseCapCost.value||NaN); const msrp=Number(msrpInput.value||NaN); const mf=Number(leaseMF.value||NaN);
    if(!entry || !isFinite(cap) || !isFinite(msrp) || !isFinite(mf) || mf<=0){ show(snprBest,false); show(snprTopGrid,false); show(snprAdvanced,false); return; }

    const curTerm = termSel.value ? Number(termSel.value) : NaN;
    const curMiles = annualMilesSel.value ? Number(annualMilesSel.value) : NaN;

    const months = visibleMonthsFor(entry).map(x=>Number(x)).filter(n=>isFinite(n));
    const milesSet = sniffVaryMiles.checked ? allMileageBands() : [curMiles];
    const pacpoOptions = sniffAllowPacpoOff.checked ? [true,false] : [true];

    const rows=[];
    for(const t of months){
      for(const m of milesSet){
        for(const pOn of pacpoOptions){
          const rvPct = computeRV(entry,String(t),m,pOn,dispYear,yrKey);
          if(rvPct==null) continue;
          // temporarily set leaseTerm to term t for payment calc
          const oldLeaseTerm = leaseTerm.value; leaseTerm.value = String(t);
          const pay = paymentFor(rvPct);
          leaseTerm.value = oldLeaseTerm;
          if(pay.withTax==null) continue;
          const lvi = computeLVI(rvPct, mf);
          rows.push({term:t, miles:m, pacpo:pOn, rvPct:+rvPct.toFixed(2), lvi: lvi ? +lvi.toFixed(2) : null, pre:pay.pre, withTax:pay.withTax, perMi: pay.pre && m ? (pay.pre/m) : null});
        }
      }
    }

    if(!rows.length){ show(snprBest,false); show(snprTopGrid,false); show(snprAdvanced,false); return; }

    // Sort: withTax asc ‚Üí rv% desc ‚Üí lvi desc ‚Üí term asc
    rows.sort((a,b)=>{
      if(a.withTax!==b.withTax) return a.withTax-b.withTax;
      if(a.rvPct!==b.rvPct) return b.rvPct-a.rvPct;
      if((a.lvi||0)!==(b.lvi||0)) return (b.lvi||0)-(a.lvi||0);
      return a.term-b.term;
    });

    // Best
    const best=rows[0];
    snprBestPay.textContent='$'+Math.round(best.withTax).toLocaleString();
    snprBestMeta.textContent=`${best.term} mo ‚Ä¢ ${best.miles.toLocaleString()} mi/yr ‚Ä¢ ${best.pacpo?'+2% PACPO':'PACPO Off'} ‚Ä¢ RV ${best.rvPct}%`;
    // Œî vs current with-tax
    const curWt = leaseWithTax.textContent && leaseWithTax.textContent.startsWith('$') ? Number(leaseWithTax.textContent.replace(/[$,]/g,'')) : NaN;
    if(isFinite(curWt)){ const d=Math.round(best.withTax - curWt); snprDelta.textContent=`Œî vs current: ${d>0?'+':''}$${Math.abs(d).toLocaleString()}`; snprDelta.className='small '+(d<=0?'delta pos':'delta neg'); } else { snprDelta.textContent='Œî vs current: ‚Äî'; snprDelta.className='small'; }
    show(snprBest,true);

    // Top grid
    const top = rows.slice(0,5);
    snprTopGrid.innerHTML = top.map((r,i)=>`
      <div class="cardx ${i===0?'best':''}">
        <div class="row"><div class="pillx">${r.term} mo</div><div class="pillx">${r.miles.toLocaleString()} mi/yr</div></div>
        <div class="row" style="margin-top:8px"><div class="muted">RV</div><div style="font-weight:900">${r.rvPct}%</div></div>
        <div class="row" style="margin-top:2px"><div class="muted">LVI</div><div style="font-weight:900">${r.lvi? r.lvi : '‚Äî'}</div></div>
        <div class="row" style="margin-top:8px"><div class="muted">Pre-Tax</div><div style="font-weight:900">$${Math.round(r.pre).toLocaleString()}</div></div>
        <div class="row"><div class="muted">With Tax</div><div style="font-weight:900">$${Math.round(r.withTax).toLocaleString()}</div></div>
        <div class="row" style="margin-top:6px"><div class="muted">${r.pacpo?'+2% PACPO':'PACPO Off'}</div><div class="muted">$/mi ${r.perMi? r.perMi.toFixed(2):'‚Äî'}</div></div>
      </div>`).join('');
    show(snprTopGrid, sniffShowAdvanced.checked);

    // Advanced table
    snprTbody.innerHTML = rows.slice(0,20).map(r=>`
      <tr><td>${r.term}</td><td>${r.miles.toLocaleString()}</td><td>${r.pacpo?'On':'Off'}</td><td>${r.rvPct}%</td><td>${r.lvi? r.lvi : '‚Äî'}</td><td>$${Math.round(r.pre).toLocaleString()}</td><td>$${Math.round(r.withTax).toLocaleString()}</td><td>${r.perMi? r.perMi.toFixed(2):'‚Äî'}</td></tr>
    `).join('');
    show(snprAdvanced, sniffShowAdvanced.checked);

    snprApplyBtn.onclick=()=>{
      termSel.value=String(best.term);
      annualMilesSel.value=String(best.miles);
      pacpoToggle.checked=!!best.pacpo;
      leaseTerm.value=String(best.term);
      compute(); // recompute everything with applied best
      window.scrollTo({top:document.getElementById('leaseCard').offsetTop-20,behavior:'smooth'});
    };
  }

  // Events
  programSel.addEventListener('change', ()=>{ const label=programSel.options[programSel.selectedIndex].textContent.replace(/^Program:\s*/,''); loadProgram(programSel.value,label); });
  jumpSummaryBtn.addEventListener('click', ()=>{ const el=$('summaryBox'); el && el.scrollIntoView({behavior:'smooth',block:'start'}); });
  familySel.addEventListener('change', ()=>{ populate(yearSel, yearsForFamily(familySel.value)); collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  yearSel.addEventListener('change', ()=>{ collectTrimsForYear(); populateTrims(trimSearch.value); compute(); });
  trimSearch.addEventListener('input', ()=>{ populateTrims(trimSearch.value); compute(); });
  trimSel.addEventListener('change', compute);
  termSel.addEventListener('change', ()=>{ compute(); if(leaseTerm) leaseTerm.value=termSel.value||''; leaseCompute(); });
  pacpoToggle.addEventListener('change', compute);
  hideNA.addEventListener('change', compute);
  annualMilesSel.addEventListener('change', compute);
  odoInput.addEventListener('input', compute);
  msrpInput.addEventListener('input', ()=>{ compute(); leaseCompute(); });

  exportCsvBtn.addEventListener('click', exportVisibleCSV);
  printBtn.addEventListener('click', printSummary);
  validateBtn.addEventListener('click', validateJSON);

  leaseCapCost.addEventListener('input', ()=>{ leaseCompute(); runSniffer(); });
  leaseMF.addEventListener('input', ()=>{ leaseCompute(); compute(); runSniffer(); });
  leaseTax.addEventListener('input', ()=>{ leaseCompute(); runSniffer(); });
  leaseCapReduction.addEventListener('input', ()=>{ leaseCompute(); runSniffer(); });
  leaseFees.addEventListener('input', ()=>{ leaseCompute(); runSniffer(); });
  leaseTerm.addEventListener('input', ()=>{ leaseCompute(); runSniffer(); });

  sniffAllowPacpoOff.addEventListener('change', runSniffer);
  sniffVaryMiles.addEventListener('change', runSniffer);
  sniffShowAdvanced.addEventListener('change', ()=>{ runSniffer(); });

  // Boot
  (async function boot(){
    // If ?data= present, switch selector to __current__
    if(initialProgram){ programSel.value='__current__'; }
    await loadProgram(programSel.value, programSel.options[programSel.selectedIndex].textContent.replace(/^Program:\s*/,''));
  })();

})();
</script>
</body>
</html>
